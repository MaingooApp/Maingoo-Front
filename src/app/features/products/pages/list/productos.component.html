<div class="flex gap-6 relative items-start bg-maingoo-mint min-h-screen p-6 -m-6">
  <div class="flex-1 min-w-0 transition-all duration-300">
    <!-- Empty State -->
    <div
      *ngIf="!cargando && productos.length === 0; else tablaProductos"
      class="card rounded-xl p-10 shadow-md text-center">
      <i class="pi pi-warehouse text-gray-300 mb-6" style="font-size: 6rem"></i>
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">No hay productos en tu almacén</h2>
      <p class="text-gray-500">Cuando escanees una factura con productos, aparecerán aquí.</p>
    </div>

    <!-- Table content -->
    <ng-template #tablaProductos>
      <!-- Header Card with Search -->
      <div
        class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-100 grid grid-cols-1 sm:grid-cols-[auto_1fr] items-center gap-4">
        <div class="flex items-center gap-4">
          <h2 class="text-2xl font-bold text-maingoo-deep m-0 flex items-center gap-2">
            Mi almacén
          </h2>

        
        <div class="flex bg-gray-100 rounded-lg p-1 gap-1">
            <button 
                (click)="setViewMode('cards')"
                class="p-2 rounded-md transition-all duration-200 flex items-center justify-center w-8 h-8"
                [ngClass]="viewMode === 'cards' ? 'bg-white text-maingoo-sage shadow-sm' : 'text-gray-400 hover:text-gray-600'">
                <i class="pi pi-th-large text-lg"></i>
            </button>
            <button 
                (click)="setViewMode('list')"
                class="p-2 rounded-md transition-all duration-200 flex items-center justify-center w-8 h-8"
                [ngClass]="viewMode === 'list' ? 'bg-white text-maingoo-sage shadow-sm' : 'text-gray-400 hover:text-gray-600'">
                <i class="pi pi-list text-lg"></i>
            </button>
        </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center sm:justify-end w-full gap-3">
          <!-- View Toggle -->


          <button
            pButton
            label="Eliminar todo"
            icon="pi pi-trash"
            class="p-button-danger p-button-outlined w-full sm:w-auto order-2 sm:order-2"
            (click)="eliminarTodo()"
            [disabled]="productos.length === 0 || cargando"></button>

          <input
            type="text"
            pInputText
            placeholder="Buscar..."
            (input)="filterProductos($event)"
            class="border-gray-200 rounded-lg focus:border-maingoo-sage focus:ring-maingoo-sage w-full max-w-full sm:max-w-[20rem] placeholder:text-gray-400 placeholder:text-base text-left order-1 sm:order-3" />
        </div>
      </div>

      <!-- List View (similar to Suppliers) -->
      <div *ngIf="viewMode === 'list'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <p-table
          #dt
          [value]="productos"
          [rowHover]="true"
          styleClass="p-datatable-sm"
          [paginator]="true"
          [rows]="20"
          [rowsPerPageOptions]="[10, 20, 50]"
          [globalFilterFields]="['name', 'eanCode', 'category.name', 'unit']"
          [loading]="cargando">
          <ng-template pTemplate="header">
            <tr>
              <th class="text-maingoo-deep font-bold text-sm">Producto</th>
              <th class="text-maingoo-deep font-bold text-sm">Stock</th>
              <th class="text-maingoo-deep font-bold text-sm">Proveedor</th>
              <th class="text-maingoo-deep font-bold text-sm">Precio</th>
              <th class="w-20"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr
              class="cursor-pointer hover:bg-maingoo-mint/20 transition-colors border-l-4 border-transparent"
              [ngClass]="{ 'bg-maingoo-mint/10 !border-maingoo-sage': selectedProduct?.id === item.id }"
              (click)="verDetalleProducto(item)">
              <td>
                <div class="flex flex-col">
                  <span class="font-bold text-maingoo-deep">{{ item.name }}</span>
                  <div *ngIf="item.category?.name" class="mt-1">
                    <p-tag 
                      [value]="item.category.name" 
                      [style]="getCategoryStyle(item.category.name)" 
                      [rounded]="true" 
                      styleClass="text-xs font-normal border-0"></p-tag>
                  </div>
                </div>
              </td>
              <td>
                <span class="text-gray-600 text-sm font-medium">{{ item.stock | number: '1.2-2' }}</span>
                <span class="text-gray-400 text-xs ml-1">{{ item.unit }}</span>
              </td>
              <td>
                <ng-container *ngIf="loadingStats; else supplierData">
                    <p-skeleton width="80%" height="1rem"></p-skeleton>
                </ng-container>
                <ng-template #supplierData>
                    <span class="text-gray-600 text-sm font-medium">{{ productStats.get(item.id)?.supplierName || '-' }}</span>
                </ng-template>
              </td>
              <td>
                <ng-container *ngIf="loadingStats; else priceData">
                    <p-skeleton width="60%" height="1rem"></p-skeleton>
                </ng-container>
                <ng-template #priceData>
                    <span *ngIf="productStats.get(item.id)?.lastPrice" class="text-maingoo-deep font-bold text-sm">
                        {{ productStats.get(item.id)?.lastPrice | currency:'EUR' }}
                    </span>
                    <span *ngIf="!productStats.get(item.id)?.lastPrice" class="text-gray-400 text-sm italic">-</span>
                </ng-template>
              </td>
              <td class="text-right">
                <button
                  pButton
                  icon="pi pi-chevron-left"
                  class="p-button-text p-button-secondary p-button-sm transition-transform duration-200"
                  [ngClass]="{ 'rotate-180 text-maingoo-sage': selectedProduct?.id === item.id }"></button>
              </td>
            </tr>
          </ng-template>
          <!-- Empty State in Table -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center py-8 text-gray-500">No se encontraron productos.</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
      
      <!-- Category Cards Grid -->
      <div *ngIf="viewMode === 'cards'" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-fade-in">
        <div 
            *ngFor="let category of uniqueCategories" 
            (click)="selectCategory(category.name)"
            class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-maingoo-sage transition-all cursor-pointer group flex flex-col h-full">
            
            <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-full bg-maingoo-mint/20 flex items-center justify-center text-maingoo-sage group-hover:bg-maingoo-sage group-hover:text-white transition-colors duration-300">
                    <i class="pi pi-tags text-xl"></i>
                </div>
                <div class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded-md">
                    {{ category.count }} prod.
                </div>
            </div>
            
            <h3 class="text-lg font-bold text-maingoo-deep mb-2 group-hover:text-maingoo-sage transition-colors line-clamp-2">
                {{ category.name }}
            </h3>
            
            <div class="mt-auto pt-4 border-t border-gray-50 flex justify-between items-center text-xs text-gray-400">
                <span>Categoría</span>
                <span class="text-maingoo-sage font-medium flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                    Ver <i class="pi pi-arrow-right text-[10px]"></i>
                </span>
            </div>
        </div>

        <!-- Empty State for Categories -->
        <div *ngIf="uniqueCategories.length === 0" class="col-span-full">
            <div class="bg-white rounded-xl border border-dashed border-gray-300 p-12 text-center">
                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="pi pi-inbox text-3xl text-gray-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-700">No hay categorías</h3>
                <p class="text-gray-500 mt-1">No se encontraron productos con categoría asignada.</p>
            </div>
        </div>
      </div>
    </ng-template>
  </div>

  <!-- Responsive Detail Container -->
  <ng-container *ngIf="selectedProduct">
    <!-- DESKTOP: Side Panel (Sticky, In-Flow) -->
    <div
      class="hidden md:flex w-full md:w-1/2 shrink-0 sticky top-4 rounded-xl overflow-hidden shadow-2xl bg-white border border-gray-100 transition-all duration-300 animate-slide-in-right z-20 h-[calc(100vh-2rem)] flex-col">
      <ng-container *ngTemplateOutlet="detailContent"></ng-container>
    </div>

    <!-- MOBILE: Bottom Sheet (Fixed, Overlay) -->
    <div class="md:hidden fixed inset-0 z-50 flex items-end justify-center">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" (click)="hideDialog()"></div>

      <!-- Sheet -->
      <div
        class="relative w-full h-[85vh] bg-white rounded-t-3xl shadow-[0_-4px_30px_rgba(0,0,0,0.15)] flex flex-col animate-slide-up overflow-hidden">
        <!-- Drag Handle Area -->
        <div
          class="w-full flex justify-center pt-4 pb-2 bg-white shrink-0 cursor-grab active:cursor-grabbing"
          (click)="hideDialog()">
          <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <!-- Content Wrapper -->
        <div class="flex-1 overflow-hidden relative flex flex-col">
          <ng-container *ngTemplateOutlet="detailContent"></ng-container>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- CATEGORY SIDEBAR -->
  <ng-container *ngIf="selectedCategory">
    <!-- DESKTOP: Side Panel -->
    <div class="hidden md:flex w-full md:w-1/2 shrink-0 sticky top-4 rounded-xl overflow-hidden shadow-2xl bg-white border border-gray-100 transition-all duration-300 animate-slide-in-right z-20 h-[calc(100vh-2rem)] flex-col">
        <ng-container *ngTemplateOutlet="categoryDetailContent"></ng-container>
    </div>

    <!-- MOBILE: Bottom Sheet -->
    <div class="md:hidden fixed inset-0 z-50 flex items-end justify-center">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" (click)="closeCategoryDetail()"></div>

      <!-- Sheet -->
      <div class="relative w-full h-[85vh] bg-white rounded-t-3xl shadow-[0_-4px_30px_rgba(0,0,0,0.15)] flex flex-col animate-slide-up overflow-hidden">
        <!-- Drag Handle Area -->
        <div class="w-full flex justify-center pt-4 pb-2 bg-white shrink-0 cursor-grab active:cursor-grabbing" (click)="closeCategoryDetail()">
          <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <!-- Content Wrapper -->
        <div class="flex-1 overflow-hidden relative flex flex-col">
          <ng-container *ngTemplateOutlet="categoryDetailContent"></ng-container>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- CATEGORY CONTENT TEMPLATE -->
  <ng-template #categoryDetailContent>
        <!-- Header -->
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center shrink-0">
            <h2 class="text-xl font-bold text-maingoo-deep flex items-center gap-2">
                <i class="pi pi-th-large text-maingoo-sage"></i>
                {{ selectedCategory }}
            </h2>
            <button 
                (click)="closeCategoryDetail()"
                class="p-button-rounded p-button-text text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center transition-colors">
                <i class="pi pi-times"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-auto p-4">
            <p class="text-gray-500 mb-4 text-sm px-2">Mostrando <strong>{{ categoryProducts.length }}</strong> productos en esta categoría.</p>
            
            <div class="h-full flex flex-col">
                <p-table
                  [value]="categoryProducts"
                  [rowHover]="true"
                  styleClass="p-datatable-sm"
                  [scrollable]="true"
                  scrollHeight="flex">
                  <ng-template pTemplate="header">
                    <tr>
                      <th class="text-maingoo-deep font-bold text-sm bg-gray-50 border-gray-100">Producto</th>
                      <th class="text-maingoo-deep font-bold text-sm bg-gray-50 border-gray-100 w-24">Stock</th>
                      <th class="text-maingoo-deep font-bold text-sm bg-gray-50 border-gray-100">Proveedor</th>
                      <th class="text-maingoo-deep font-bold text-sm bg-gray-50 border-gray-100 w-24">Precio</th>
                      <th class="w-10 bg-gray-50 border-gray-100"></th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr
                      class="cursor-pointer hover:bg-maingoo-mint/20 transition-colors border-l-4 border-transparent"
                      [ngClass]="{ 'bg-maingoo-mint/10 !border-maingoo-sage': selectedProduct?.id === item.id }"
                      (click)="verDetalleProducto(item)">
                      <td class="border-gray-100">
                        <div class="flex flex-col">
                          <span class="font-bold text-maingoo-deep text-sm">{{ item.name }}</span>
                          <span class="text-xs text-gray-500" *ngIf="item.brand">{{ item.brand }}</span>
                        </div>
                      </td>
                      <td class="border-gray-100">
                        <span class="text-gray-600 text-sm font-medium">{{ item.stock | number: '1.0-0' }}</span>
                        <span class="text-gray-400 text-xs ml-1">{{ item.unit }}</span>
                      </td>
                      <td class="border-gray-100">
                        <span class="text-gray-600 text-sm font-medium">{{ productStats.get(item.id)?.supplierName || '-' }}</span>
                      </td>
                      <td class="border-gray-100">
                         <span *ngIf="productStats.get(item.id)?.lastPrice" class="text-maingoo-deep font-bold text-sm">
                            {{ productStats.get(item.id)?.lastPrice | currency:'EUR' }}
                         </span>
                         <span *ngIf="!productStats.get(item.id)?.lastPrice" class="text-gray-400 text-sm italic">-</span>
                      </td>
                      <td class="text-right border-gray-100 px-2">
                        <i class="pi pi-chevron-right text-gray-300 text-xs"></i>
                      </td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="4" class="text-center py-8 text-gray-500">No se encontraron productos.</td>
                    </tr>
                  </ng-template>
                </p-table>
            </div>
        </div>
  </ng-template>


  <!-- SHARED CONTENT TEMPLATE -->
  <ng-template #detailContent>
    <!-- ... existing detail content ... -->
    <div class="px-6 pb-24 md:pb-8 relative pt-6 flex-1 overflow-y-auto" (click)="showMenu = false">
      <!-- Actions Row -->
      <div class="flex justify-end gap-2 mb-4">
        <!-- Hamburger Menu -->
        <div class="relative">
          <button
            class="p-button-rounded p-button-text text-gray-400 hover:bg-gray-100 hover:text-maingoo-deep w-10 h-10 items-center justify-center flex transition-all duration-200"
            (click)="toggleMenu($event)">
            <i class="pi pi-ellipsis-v"></i>
          </button>

          <!-- Dropdown Menu -->
          <div
            *ngIf="showMenu"
            class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-xl py-1 z-50 border border-gray-100 overflow-hidden animate-fade-in origin-top-right">
            <button
              (click)="confirmarEliminarProducto(selectedProduct!)"
              class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors">
              <i class="pi pi-trash"></i>
              Eliminar
            </button>
          </div>
        </div>

        <!-- Close Button -->
        <button
          class="p-button-rounded p-button-text text-gray-400 hover:bg-gray-100 hover:text-red-600 w-10 h-10 items-center justify-center flex transition-all duration-200"
          (click)="hideDialog()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <!-- Title and Image -->
      <div class="mb-6 flex justify-between items-start gap-6">
        <div class="flex-1 pt-2 flex flex-col gap-2">
          <h1 class="text-2xl md:text-3xl font-bold text-maingoo-deep leading-tight break-words">
            {{ selectedProduct?.name }}
          </h1>
          <!-- Category -->
          <div *ngIf="selectedProduct?.category?.name" class="flex flex-col gap-1.5">
            <span class="text-[10px] uppercase tracking-wider font-bold text-gray-400">Categoría</span>
            <div>
                <p-tag 
                [value]="selectedProduct!.category.name" 
                [style]="getCategoryStyle(selectedProduct!.category.name)" 
                [rounded]="true" 
                styleClass="text-sm font-normal border-0 px-3 py-1"></p-tag>
            </div>
          </div>
          
          <!-- Allergens Tags -->
           <div class="flex flex-col gap-1.5 mt-3" *ngIf="selectedProduct?.allergens && selectedProduct!.allergens.length > 0">
             <span class="text-[10px] uppercase tracking-wider font-bold text-gray-400">Alérgenos</span>
             <div class="flex flex-wrap gap-2">
                 <p-tag 
                *ngFor="let alergeno of selectedProduct?.allergens" 
                [value]="alergeno.name" 
                severity="warn" 
                [rounded]="true"
                icon="pi pi-exclamation-triangle"
                [pTooltip]="alergeno.description"
                tooltipPosition="top"
                styleClass="text-xs font-normal border-0 px-2 py-0.5 bg-orange-100/80 text-orange-800"></p-tag>
             </div>
           </div>
        </div>
        
        <!-- Image Placeholder -->
        <div class="w-40 h-40 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center shrink-0 overflow-hidden shadow-sm">
          <i class="pi pi-image text-gray-300 text-5xl"></i>
        </div>
      </div>

      <!-- Information Sections (Adapted from Product Detail) -->
      <div class="flex flex-col gap-6">
        <!-- Main Info -->
        <div class="space-y-3">
          <h3 class="text-lg font-semibold flex items-center gap-2 text-maingoo-deep">
            <i class="pi pi-info-circle text-maingoo-sage"></i>
            Detalles del producto
          </h3>
          <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-2 text-sm text-gray-700">
            <p><strong class="text-maingoo-deep">Descripción:</strong> {{ selectedProduct?.description || 'Sin descripción' }}</p>
            <p><strong class="text-maingoo-deep">Unidad de medida:</strong> {{ selectedProduct?.unit }}</p>
            <p><strong class="text-maingoo-deep">Stock:</strong> {{ selectedProduct?.stock }}</p>
          </div>
        </div>



        <!-- Audit -->
        <div class="space-y-3">
          <h3 class="text-lg font-semibold flex items-center gap-2 text-maingoo-deep">
            <i class="pi pi-clock text-maingoo-sage"></i>
            Auditoría
          </h3>
          <div class="flex gap-4 text-xs text-gray-500">
            <div>
              <p class="font-medium text-maingoo-deep">Añadido el</p>
              <p>{{ selectedProduct?.createdAt | date: 'dd/MM/yyyy HH:mm' }}</p>
            </div>
            <div>
              <p class="font-medium text-maingoo-deep">Actualizado el</p>
              <p>{{ selectedProduct?.updatedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
            </div>
          </div>
        </div>

        <!-- Price Evolution Chart -->
        <div *ngIf="priceChartData && !loadingInvoices" class="space-y-3 pt-4 border-t border-gray-100">
           <h3 class="text-lg font-semibold flex items-center gap-2 text-maingoo-deep">
            <i class="pi pi-chart-line text-maingoo-sage"></i>
            Evolución de precio
          </h3>
          <div class="h-48 w-full bg-gray-50/50 rounded-xl p-2 border border-dashed border-gray-100">
            <p-chart type="line" [data]="priceChartData" [options]="priceChartOptions" height="100%" width="100%"></p-chart>
          </div>
        </div>

        <!-- Related Invoices -->
        <div class="space-y-3 pt-4 border-t border-gray-100">
          <h3 class="text-lg font-semibold flex items-center gap-2 text-maingoo-deep">
            <i class="pi pi-file text-maingoo-sage"></i>
            Facturas asociadas ({{ relatedInvoices.length }})
          </h3>
          
          <div *ngIf="loadingInvoices" class="flex justify-center py-8">
            <i class="pi pi-spin pi-spinner text-maingoo-sage text-2xl"></i>
          </div>

          <div *ngIf="!loadingInvoices">
            <div *ngIf="relatedInvoices.length > 0; else noInvoices" class="space-y-2">
              <div 
                *ngFor="let invoice of relatedInvoices" 
                class="p-3 bg-white border border-gray-200 rounded-xl hover:border-maingoo-sage transition-colors flex justify-between items-center group cursor-pointer"
                (click)="verFactura(invoice)">
                <div class="flex flex-col">
                  <span class="font-medium text-maingoo-deep text-sm">{{ invoice.supplier.name || 'Proveedor desconocido' }}</span>
                  <span class="text-xs text-gray-500">{{ invoice.date | date:'dd MMM yyyy' }} • {{ invoice.invoiceNumber }}</span>
                </div>
                <div class="flex items-center gap-3">
                  <span class="font-bold text-maingoo-deep text-sm">{{ invoice.amount | currency:'EUR' }}</span>
                  <i class="pi pi-chevron-right text-gray-300 group-hover:text-maingoo-sage"></i>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #noInvoices>
            <div class="p-4 rounded-xl bg-gray-50 text-gray-500 text-sm text-center italic border border-dashed border-gray-200">
              No se han encontrado facturas para este producto.
            </div>
          </ng-template>
        </div>


      </div>
    </div>
  </ng-template>
</div>

<p-confirmDialog
  header="Confirmación"
  icon="pi pi-exclamation-triangle"
  [style]="{ width: '400px' }"></p-confirmDialog>
