<!-- List View -->
<div *ngIf="!showForm" class="flex flex-col gap-4 animate-fade-in">
	<div *ngFor="let elaboration of elaborations"
		class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow cursor-pointer">
		<div class="flex items-center gap-3">
			<div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500">
				<app-icon name="skillet" size="md"></app-icon>
			</div>
			<div>
				<h3 class="font-bold text-gray-900">{{ elaboration.name }}</h3>
				<p class="text-sm text-gray-500">{{ elaboration.ingredients.length }} ingredientes</p>
			</div>
		</div>
		<div class="flex items-center gap-2">
			<button pButton class="p-button-text p-button-rounded text-gray-400" aria-label="Opciones">
				<app-icon name="more_vert" size="md"></app-icon>
			</button>
		</div>
	</div>

	<!-- Empty State -->
	<div *ngIf="elaborations.length === 0" class="flex flex-col items-center justify-center py-12 text-center">
		<div class="w-16 h-16 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 mb-4">
			<app-icon name="skillet" size="xl"></app-icon>
		</div>
		<h3 class="text-lg font-medium text-gray-900">No hay elaboraciones</h3>
		<p class="text-sm text-gray-500 max-w-xs mx-auto mt-1">Crea tu primera elaboración pulsando el botón de
			arriba.</p>
	</div>
</div>

<!-- Creation Form -->
<div *ngIf="showForm" class="flex flex-col gap-4 animate-fade-in">
	<div class="flex flex-col gap-4">
		<div class="flex flex-col gap-1">
			<label class="text-sm font-medium text-gray-700">Nombre de elaboración</label>
			<input pInputText type="text" [ngModel]="newElaborationName()"
				(ngModelChange)="newElaborationName.set($event)" placeholder="Ej: Salsa de tomate" class="w-full" />
		</div>

		<!-- Ingredients Section -->
		<div class="flex flex-col gap-2 transition-all">
			<label class="text-sm font-medium text-gray-700">Productos / Elaboraciones</label>

			<div class="flex flex-col gap-3">
				<div *ngFor="let row of ingredientRows(); let i = index" class="flex gap-3 items-start animate-fade-in">
					<!-- Type Selector (20%) -->
					<div class="flex-[2] min-w-0">
						<p-dropdown [options]="ingredientTypes" [(ngModel)]="ingredientRows()[i].type"
							optionLabel="label" optionValue="value" styleClass="w-full" [appendTo]="'body'">
						</p-dropdown>
					</div>

					<!-- Search Item (40%) -->
					<div class="flex-[4] min-w-0">
						<p-autocomplete [(ngModel)]="ingredientRows()[i].selectedItem" [suggestions]="filteredItems"
							(completeMethod)="filterItems($event, row.type)" optionLabel="name"
							[placeholder]="row.type === 'product' ? 'Buscar producto...' : 'Buscar elaboración...'"
							styleClass="w-full"
							inputStyleClass="w-full border-gray-200 rounded-lg focus:border-maingoo-sage focus:ring-maingoo-sage placeholder:text-gray-400"
							[appendTo]="'body'">
							<ng-template let-item pTemplate="item">
								<div class="flex items-center gap-2">
									<span>{{ item.name }}</span>
								</div>
							</ng-template>
						</p-autocomplete>
					</div>

					<!-- Unit Selector (14%) -->
					<div class="flex-[1.4] min-w-0">
						<p-dropdown [options]="amountUnits" [(ngModel)]="ingredientRows()[i].unit" optionLabel="label"
							optionValue="value" styleClass="w-full" [appendTo]="'body'">
						</p-dropdown>
					</div>
					<!-- Amount (14%) -->
					<div class="flex-[1.4] min-w-0">
						<input pInputText type="text" [(ngModel)]="ingredientRows()[i].amount"
							[placeholder]="ingredientRows()[i].unit === 'g' ? 'g' : 'uds'" class="w-full" />
					</div>
					<!-- Precio calculado (10%) -->
					<div class="flex-1 min-w-0 h-[42px] px-2 flex items-center justify-end bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium"
						[ngClass]="getRowPrice(row) != null ? 'text-gray-900' : 'text-gray-400'">
						{{ getRowPrice(row) != null ? (getRowPrice(row) | currency:'EUR':'symbol':'1.2-2':'es-ES') : '—'
						}}
					</div>

					<!-- Remove Button -->
					<button pButton
						class="p-button-text p-button-danger p-button-rounded !w-10 !h-10 flex items-center justify-center shrink-0"
						(click)="removeIngredientRow(i)" *ngIf="ingredientRows().length > 1">
						<app-icon name="delete" size="md"></app-icon>
					</button>
				</div>
			</div>

			<button pButton
				class="p-button-text p-button-sm self-start mt-1 text-maingoo-sage hover:text-maingoo-deep flex items-center gap-2"
				(click)="addIngredientRow()">
				<app-icon name="add" size="sm"></app-icon>
				<span>Añadir producto o elaboración</span>
			</button>
		</div>

		<!-- Materials Section -->
		<div class="flex flex-col gap-1 transition-all">
			<label class="text-sm font-medium text-gray-700">Materiales</label>
			<textarea pInputTextarea [ngModel]="elaborationMaterials()"
				(ngModelChange)="elaborationMaterials.set($event)" rows="4" class="w-full"
				placeholder="Tabla de cortar, cuchillos, varillas, bowl metalico, bascula, etc..."
				[autoResize]="true"></textarea>
		</div>

		<!-- Step by Step Section -->
		<div class="flex flex-col gap-1 transition-all">
			<label class="text-sm font-medium text-gray-700">Paso a paso</label>
			<textarea pInputTextarea [ngModel]="elaborationSteps()" (ngModelChange)="elaborationSteps.set($event)"
				rows="4" class="w-full" placeholder="Describe los pasos de la elaboración..."
				[autoResize]="true"></textarea>
		</div>

		<div class="flex justify-end gap-2 mt-2">
			<button pButton label="Cancelar" class="p-button-text" (click)="cancelForm()"></button>
			<button pButton class="p-button-primary flex items-center gap-2" (click)="onSave()">
				<span>Generar Elaboración</span>
				<app-icon name="wand_stars" size="xl"></app-icon>
			</button>
		</div>
	</div>
</div>