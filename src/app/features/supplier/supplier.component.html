<div class="flex flex-col gap-6 relative items-start bg-maingoo-mint min-h-screen p-6 -m-6">

  <div class="flex-1 w-full min-w-0 transition-all duration-300">
    <!-- Header Card with Search (Full Width) -->
    <app-section-header class="w-full" title="Proveedores" [viewMode]="viewMode"
      searchPlaceholder="Buscar un proveedor..." (viewModeChange)="viewMode = $any($event)"
      (search)="filterSuppliers($event)">
      <div actions>
        <button pButton label="Subir Factura" icon="pi pi-receipt" severity="primary" (click)="openAddInvoiceModal()">
        </button>
      </div>
    </app-section-header>

    <!-- Main Content Wrapper (Row) -->
    <div class="flex flex-row gap-6 w-full items-start">

      <!-- Left Side: Main Content (Table + Grid) -->
      <div class="flex-1 min-w-0 transition-all duration-300">
        <div *ngIf="supplier.length === 0; else tablaSupplier" class="card rounded-xl p-10 shadow-md text-center">
          <i class="pi pi-truck text-gray-300 mb-6" style="font-size: 6rem"></i>
          <h2 class="text-2xl font-semibold text-gray-700 mb-2">No hay proveedores registrados</h2>
          <p class="text-gray-500">Cuando registres un proveedor, aparecerá aquí.</p>
        </div>

        <ng-template #tablaSupplier>

          <!-- Grid View -->
          <ng-container *ngIf="viewMode === 'grid'">
            <div class="grid gap-6 transition-all duration-300" [ngClass]="
            selectedSupplier ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-4'
          ">
              <div *ngFor="let item of filteredSupplier"
                class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg ring-1 ring-transparent hover:ring-maingoo-sage transition-all duration-300 cursor-pointer group relative h-32 flex flex-col"
                (click)="showDialog(item)">
                <!-- Card Banner / Image Placeholder -->
                <div
                  class="h-12 shrink-0 bg-gradient-to-br from-maingoo-deep to-maingoo-sage flex items-center justify-center p-2 relative">
                  <!-- Generating a pseudo-logo based on name initials -->
                  <span class="text-4xl font-bold text-white/90 select-none">
                    {{ item.commercialName?.charAt(0) || item.name.charAt(0) | uppercase }}
                  </span>
                </div>

                <!-- Card Content -->
                <div class="p-3 bg-white text-maingoo-deep flex-1 flex flex-col justify-between">
                  <div class="flex items-center gap-3">
                    <i class="pi pi-box text-maingoo-sage text-xl"></i>
                    <div class="flex flex-col overflow-hidden">
                      <span class="font-bold text-lg truncate" [title]="item.commercialName || item.name">
                        {{ item.commercialName || item.name }}
                      </span>
                      <span class="text-sm text-gray-500 truncate"
                        *ngIf="item.commercialName && item.name !== item.commercialName">
                        {{ item.name }}
                      </span>
                    </div>
                  </div>
                  <!-- Optional: Add more details if needed, e.g. phone -->
                  <div class="mt-2 text-sm text-gray-500 flex items-center gap-2" *ngIf="item.phoneNumber">
                    <i class="pi pi-phone text-xs text-maingoo-sage"></i>
                    {{ item.phoneNumber }}
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- List View -->
          <div *ngIf="viewMode === 'list'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <p-table [value]="filteredSupplier" [rowHover]="true" styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th class="text-maingoo-deep font-bold text-sm">Proveedor</th>
                  <th class="text-maingoo-deep font-bold text-sm">NIF/CIF</th>
                  <th class="text-maingoo-deep font-bold text-sm">Reg. Sanitario</th>
                  <th class="w-20"></th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr class="cursor-pointer hover:bg-maingoo-mint/20 transition-colors border-l-4 border-transparent"
                  [ngClass]="{ 'bg-maingoo-mint/10 !border-maingoo-sage': selectedSupplier?.id === item.id }"
                  (click)="showDialog(item)">
                  <td>
                    <div class="flex flex-col">
                      <span class="font-bold text-maingoo-deep">{{ item.commercialName || item.name }}</span>
                      <span class="text-xs text-gray-500"
                        *ngIf="item.commercialName && item.name !== item.commercialName">{{ item.name }}</span>
                    </div>
                  </td>
                  <td>
                    <span class="text-gray-600 text-sm">{{ item.cifNif || '-' }}</span>
                  </td>
                  <td>
                    <span class="text-gray-600 text-sm">{{ item.sanitaryRegistrationNumber || '-' }}</span>
                  </td>
                  <td class="text-right">
                    <button pButton icon="pi pi-chevron-left"
                      class="p-button-text p-button-secondary p-button-sm transition-transform duration-200"
                      [ngClass]="{ 'rotate-180 text-maingoo-sage': selectedSupplier?.id === item.id }"></button>
                  </td>
                </tr>
              </ng-template>
              <!-- Empty State in Table -->
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="4" class="text-center py-8 text-gray-500">No se encontraron proveedores.</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </ng-template>
      </div>

      <!-- Responsive Detail Container -->
      <ng-container *ngIf="selectedSupplier">
        <!-- DESKTOP: Side Panel (Sticky, In-Flow) -->
        <div
          class="hidden md:flex w-full md:w-1/2 shrink-0 sticky top-4 rounded-xl overflow-hidden shadow-2xl bg-white border border-gray-100 transition-all duration-300 animate-slide-in-right z-20 h-[calc(100vh-2rem)] flex-col">
          <ng-container *ngTemplateOutlet="detailContent"></ng-container>
        </div>

        <!-- MOBILE: Bottom Sheet (Fixed, Overlay) -->
        <div class="md:hidden fixed inset-0 z-50 flex items-end justify-center">
          <!-- Backdrop -->
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" (click)="hideDialog()"></div>

          <!-- Sheet -->
          <div
            class="relative w-full h-[85vh] bg-white rounded-t-3xl shadow-[0_-4px_30px_rgba(0,0,0,0.15)] flex flex-col animate-slide-up overflow-hidden">
            <!-- Drag Handle Area -->
            <div class="w-full flex justify-center pt-4 pb-2 bg-white shrink-0 cursor-grab active:cursor-grabbing"
              (click)="hideDialog()">
              <!-- Click on handle acts as close for simplicity or add swipe logic later -->
              <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>

            <!-- Content Wrapper -->
            <div class="flex-1 overflow-hidden relative flex flex-col">
              <ng-container *ngTemplateOutlet="detailContent"></ng-container>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- SHARED CONTENT TEMPLATE -->
    <ng-template #detailContent>
      <!-- Cover Image Area -->
      <div class="h-16 w-full relative shrink-0">
        <div class="absolute top-4 right-4 flex gap-2 items-center">
          <!-- Hamburger Menu -->
          <div class="relative">
            <button
              class="p-button-rounded p-button-text text-gray-400 hover:bg-gray-100 hover:text-maingoo-deep w-10 h-10 items-center justify-center flex transition-all duration-200"
              (click)="toggleMenu($event)">
              <i class="pi pi-ellipsis-v"></i>
            </button>

            <!-- Dropdown Menu -->
            <div *ngIf="showMenu"
              class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-xl py-1 z-50 border border-gray-100 overflow-hidden animate-fade-in origin-top-right">
              <button (click)="downloadSupplier()"
                class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-maingoo-mint hover:text-maingoo-deep flex items-center gap-2 transition-colors">
                <i class="pi pi-download"></i>
                Descargar información
              </button>
              <div class="h-px bg-gray-100 my-1"></div>
              <button (click)="editSupplier(selectedSupplier!)"
                class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-maingoo-mint hover:text-maingoo-deep flex items-center gap-2 transition-colors">
                <i class="pi pi-pencil"></i>
                Editar
              </button>
              <button (click)="confirmDelete(selectedSupplier!)"
                class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors">
                <i class="pi pi-trash"></i>
                Eliminar
              </button>
            </div>
          </div>

          <!-- Close Button -->
          <button
            class="p-button-rounded p-button-text text-gray-400 hover:bg-gray-100 hover:text-red-600 w-10 h-10 items-center justify-center flex transition-all duration-200"
            (click)="hideDialog()">
            <i class="pi pi-times"></i>
          </button>
        </div>
      </div>

      <div class="px-6 pb-24 md:pb-8 relative flex-1 overflow-y-auto" (click)="showMenu = false">

        <!-- Title and Image -->
        <div class="mb-6 flex justify-between items-start gap-6">
          <div class="flex-1 pt-2 flex flex-col gap-2">
            <h1 class="text-2xl md:text-3xl font-bold text-maingoo-deep leading-tight break-words">
              {{ selectedSupplier?.name }}
            </h1>
            <div class="flex gap-2" *ngIf="selectedSupplier?.commercialName">
              <p-tag [value]="selectedSupplier!.commercialName!" severity="info" [rounded]="true"
                styleClass="text-sm font-normal border-0 px-3 py-1 bg-maingoo-mint/30 text-maingoo-deep"></p-tag>
            </div>
          </div>

          <!-- Image Placeholder -->
          <div
            class="w-40 h-40 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center shrink-0 overflow-hidden shadow-sm">
            <i class="pi pi-image text-gray-300 text-5xl"></i>
          </div>
        </div>
        <!-- Helper for inline input -->
        <ng-template #inlineInput let-label="label" let-value="value" let-icon="icon">
          <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
            <div class="flex items-center gap-2 text-gray-400 text-sm">
              <i [class]="'pi ' + icon + ' text-maingoo-sage'"></i>
              <span>{{ label }}</span>
            </div>
            <div class="flex items-center">
              <input type="text" [value]="value || ''" placeholder="Vacío"
                class="bg-transparent border border-transparent hover:border-maingoo-sage/30 focus:border-maingoo-sage text-maingoo-deep focus:outline-none rounded px-2 py-0.5 w-full -ml-2 transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm" />
            </div>
          </div>
        </ng-template>

        <!-- Unified Properties List -->
        <div class="flex flex-col gap-2">
          <!-- Address -->
          <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]"
            *ngIf="selectedSupplier?.address">
            <div class="flex items-center gap-2 text-gray-400 text-sm">
              <i class="pi pi-map-marker text-maingoo-sage"></i>
              <span>Dirección</span>
            </div>
            <div class="flex items-center -ml-2">
              <span
                class="text-maingoo-deep font-medium border-b border-transparent hover:border-maingoo-sage/30 transition-colors px-2 py-0.5 text-sm w-full truncate">{{
                selectedSupplier?.address }}</span>
            </div>
          </div>

          <!-- Sanitary Registration -->
          <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
            <div class="flex items-center gap-2 text-gray-400 text-sm">
              <i class="pi pi-file text-maingoo-sage"></i>
              <span>Reg. Sanitario</span>
            </div>
            <div class="flex items-center -ml-2">
              <input type="text" [value]="selectedSupplier?.sanitaryRegistrationNumber || ''" placeholder="Vacío"
                class="bg-transparent border border-transparent hover:border-maingoo-sage/30 focus:border-maingoo-sage text-maingoo-deep font-medium focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm" />
            </div>
          </div>

          <!-- CIF/NIF -->
          <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
            <div class="flex items-center gap-2 text-gray-400 text-sm">
              <i class="pi pi-id-card text-maingoo-sage"></i>
              <span>CIF/NIF</span>
            </div>
            <div class="flex items-center -ml-2">
              <span class="text-maingoo-deep font-medium text-sm px-2 py-0.5">{{
                selectedSupplier?.cifNif || 'Vacío'
                }}</span>
            </div>
          </div>

          <!-- Contacto Comercial SECTION -->
          <div class="group">
            <!-- Inline Toggle Header -->
            <div class="grid grid-cols-[130px_1fr] items-center py-1 min-h-[32px] cursor-pointer"
              (click)="showContact = !showContact">
              <div class="flex items-center gap-2 text-gray-400 text-sm">
                <i class="pi pi-briefcase text-maingoo-sage"></i>
                <span>Contacto</span>
              </div>
              <div class="flex items-center">
                <p-inputSwitch [(ngModel)]="showContact" (click)="$event.stopPropagation()"
                  styleClass="scale-75"></p-inputSwitch>
              </div>
            </div>

            <div class="overflow-hidden transition-all duration-300 ease-in-out"
              [style.max-height]="showContact ? '500px' : '0'" [style.opacity]="showContact ? '1' : '0'">
              <div class="flex flex-col gap-1 py-1 pl-6">
                <!-- Persona de contacto -->
                <ng-container *ngTemplateOutlet="
                  inlineInput;
                  context: { label: 'Persona', icon: 'pi-user', value: '' }
                "></ng-container>

                <!-- Telefono -->
                <ng-container *ngTemplateOutlet="
                  inlineInput;
                  context: { label: 'Teléfono', icon: 'pi-phone', value: selectedSupplier?.phoneNumber }
                "></ng-container>

                <!-- Email -->
                <ng-container *ngTemplateOutlet="
                  inlineInput;
                  context: { label: 'Email', icon: 'pi-envelope', value: '' }
                "></ng-container>
              </div>
            </div>
          </div>

          <!-- Reparto SECTION -->
          <div class="group">
            <!-- Inline Toggle Header -->
            <div class="grid grid-cols-[130px_1fr] items-center py-1 min-h-[32px] cursor-pointer"
              (click)="showDelivery = !showDelivery">
              <div class="flex items-center gap-2 text-gray-400 text-sm">
                <i class="pi pi-truck text-maingoo-sage"></i>
                <span>Reparto</span>
              </div>
              <div class="flex items-center">
                <p-inputSwitch [(ngModel)]="showDelivery" (click)="$event.stopPropagation()"
                  styleClass="scale-75"></p-inputSwitch>
              </div>
            </div>

            <div class="overflow-hidden transition-all duration-300 ease-in-out"
              [style.max-height]="showDelivery ? '500px' : '0'" [style.opacity]="showDelivery ? '1' : '0'">
              <div class="flex flex-col gap-1 py-1">
                <div class="flex flex-col gap-1 pl-6">
                  <!-- Ultimo dia de pedido Chips -->
                  <div class="grid grid-cols-[130px_1fr] py-1 group min-h-[32px]">
                    <div class="flex items-center gap-2 text-gray-400 text-sm h-8">
                      <i class="pi pi-clock text-maingoo-sage"></i>
                      <span>Día de pedido</span>
                    </div>
                    <div class="flex flex-wrap gap-1 items-center -ml-2">
                      <div *ngFor="let day of daysOptions" (click)="toggleDay('lastOrder', day.value)"
                        class="px-2 py-1 rounded text-xs cursor-pointer transition-colors border select-none" [ngClass]="{
                        'bg-maingoo-sage text-white border-maingoo-sage': isDaySelected('lastOrder', day.value),
                        'bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200': !isDaySelected(
                          'lastOrder',
                          day.value
                        )
                      }">
                        {{ day.short }}
                      </div>
                    </div>
                  </div>

                  <!-- Dias de reparto Chips -->
                  <div class="grid grid-cols-[130px_1fr] py-1 group min-h-[32px]">
                    <div class="flex items-center gap-2 text-gray-400 text-sm h-8">
                      <i class="pi pi-calendar text-maingoo-sage"></i>
                      <span>Día de reparto</span>
                    </div>
                    <div class="flex flex-wrap gap-1 items-center -ml-2">
                      <div *ngFor="let day of daysOptions" (click)="toggleDay('delivery', day.value)"
                        class="px-2 py-1 rounded text-xs cursor-pointer transition-colors border select-none" [ngClass]="{
                        'bg-maingoo-sage text-white border-maingoo-sage': isDaySelected('delivery', day.value),
                        'bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200': !isDaySelected(
                          'delivery',
                          day.value
                        )
                      }">
                        {{ day.short }}
                      </div>
                    </div>
                  </div>
                  <!-- Pedido minimo Inline -->
                  <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                      <i class="pi pi-euro text-maingoo-sage"></i>
                      <span>Pedido mín.</span>
                    </div>
                    <div class="flex items-center -ml-2">
                      <div class="flex items-center w-full">
                        <p-inputNumber [(ngModel)]="selectedSupplier!.minPriceDelivery" mode="currency" currency="EUR"
                          locale="es-ES" placeholder="0,00 €" [minFractionDigits]="2" [maxFractionDigits]="2"
                          styleClass="w-24"
                          inputStyleClass="bg-transparent border-b border-gray-200 hover:border-maingoo-sage focus:border-maingoo-sage text-maingoo-deep font-medium focus:outline-none px-1 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm !shadow-none !rounded-none">
                        </p-inputNumber>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Section -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div (click)="showStats = !showStats"
            class="flex justify-between items-center cursor-pointer group select-none">
            <h3
              class="text-xs text-maingoo-deep/60 uppercase tracking-wider font-semibold group-hover:text-maingoo-sage transition-colors">
              Estadísticas
            </h3>
            <i class="pi pi-chevron-down text-gray-400 group-hover:text-maingoo-sage transition-transform duration-300"
              [ngClass]="{ 'rotate-180': showStats }"></i>
          </div>

          <div class="overflow-hidden transition-all duration-300 ease-in-out"
            [style.max-height]="showStats ? '1000px' : '0'">
            <div class="pt-4 px-3 pb-4">
              <!-- Monthly Expense Chart -->
              <div class="flex justify-between items-center mb-2">
                <h4 class="text-xs font-bold text-gray-400 uppercase">Gasto Mensual</h4>
                <p-dropdown [options]="availableYears" [(ngModel)]="selectedYear" (onChange)="onYearChange()"
                  optionLabel="label" optionValue="value"
                  styleClass="border-none bg-transparent p-0 text-maingoo-deep font-bold text-sm min-w-[80px]"
                  [panelStyle]="{ 'font-size': '14px' }">
                </p-dropdown>
              </div>
              <div class="h-48" *ngIf="supplierInvoices.length > 0">
                <p-chart type="bar" [data]="chartData" [options]="chartOptions" height="100%"></p-chart>
              </div>

              <!-- Historical Chart -->
              <div class="mt-6" *ngIf="supplierInvoices.length > 0">
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Histórico</h4>
                <div class="h-48">
                  <p-chart type="bar" [data]="historyChartData" [options]="chartOptions" height="100%"></p-chart>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Invoices Section -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div (click)="showInvoices = !showInvoices"
            class="flex justify-between items-center cursor-pointer group select-none">
            <h3
              class="text-xs text-maingoo-deep/60 uppercase tracking-wider font-semibold group-hover:text-maingoo-sage transition-colors">
              Facturas Asociadas
            </h3>
            <i class="pi pi-chevron-down text-gray-400 group-hover:text-maingoo-sage transition-transform duration-300"
              [ngClass]="{ 'rotate-180': showInvoices }"></i>
          </div>

          <div class="overflow-hidden transition-all duration-300 ease-in-out"
            [style.max-height]="showInvoices ? '500px' : '0'">
            <div class="pt-4 flex flex-col gap-2">
              <!-- Loading State -->
              <div *ngIf="supplierInvoices.length === 0 && !selectedSupplier"
                class="text-center py-4 text-gray-400 text-sm">
                Cargando facturas...
              </div>

              <!-- No Invoices -->
              <div *ngIf="supplierInvoices.length === 0" class="text-gray-400 text-sm italic py-2">
                No hay facturas registradas.
              </div>

              <!-- Invoice List -->
              <div *ngFor="let invoice of supplierInvoices"
                class="flex items-center justify-between p-3 bg-maingoo-mint rounded-lg border border-transparent hover:border-maingoo-sage transition-colors cursor-pointer group relative"
                (click)="viewInvoice(invoice)" pTooltip="Ver factura" tooltipPosition="top">
                <div class="flex items-center gap-3">
                  <div
                    class="w-8 h-8 rounded-full bg-white text-maingoo-sage flex items-center justify-center border border-maingoo-sage/10">
                    <i class="pi pi-file text-sm"></i>
                  </div>
                  <div class="flex flex-col">
                    <span
                      class="text-maingoo-deep text-sm font-medium group-hover:text-maingoo-sage transition-colors">{{
                      invoice.invoiceNumber || 'Sin número'
                      }}</span>
                    <span class="text-gray-500 text-xs">{{ invoice.date | date: 'dd/MM/yyyy' }}</span>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="text-maingoo-deep font-bold text-sm block">{{ invoice.amount | currency: 'EUR' }}</span>
                  <button pButton icon="pi pi-eye"
                    class="p-button-rounded p-button-text p-button-sm text-maingoo-sage hover:bg-white md:hidden"
                    (click)="viewInvoice(invoice); $event.stopPropagation()"></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <style>
        @keyframes slide-in-right {
          from {
            transform: translateX(100%);
            opacity: 0;
          }

          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        .animate-slide-in-right {
          animation: slide-in-right 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slide-up {
          from {
            transform: translateY(100%);
            opacity: 0.5;
          }

          to {
            transform: translateY(0);
            opacity: 1;
          }
        }

        .animate-slide-up {
          animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
      </style>