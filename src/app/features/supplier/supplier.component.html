<div class="flex flex-col gap-6 relative items-start p-6 -m-6">
  <div class="flex-1 w-full min-w-0">
    <!-- SECTION: Header & Actions -->
    <!-- Mobile Header Controls -->
    <div class="flex md:hidden justify-between items-start mb-4 sticky top-0 z-20 pointer-events-none">
      <!-- Left: Search -->
      <div class="pointer-events-auto flex items-center gap-2 transition-all duration-300 ease-out"
        [class.w-full]="showMobileSearch" [class.mr-[105px]]="showMobileSearch">
        <button
          class="flex items-center justify-center rounded-full w-12 h-12 text-gray-600 bg-white/90 backdrop-blur-sm shadow-sm border border-gray-100 transition-all duration-200"
          [class.bg-maingoo-sage]="showMobileSearch" [class.text-white]="showMobileSearch"
          [class.border-transparent]="showMobileSearch" (click)="showMobileSearch = !showMobileSearch">
          <app-icon name="search" size="md"></app-icon>
        </button>

        <input *ngIf="showMobileSearch" type="text" pInputText placeholder="Buscar proveedor..."
          class="flex-1 h-12 shadow-lg rounded-full border-none pl-5 pr-4 text-base animate-fade-in bg-white/95 backdrop-blur-sm"
          (input)="filterSuppliers($event)" autofocus />
      </div>

      <!-- Right: View Toggle Switch -->
      <div
        class="pointer-events-auto absolute right-0 top-0 bg-white/90 backdrop-blur-sm shadow-sm border border-gray-100 rounded-full h-12 p-1 flex items-center gap-1">
        <!-- Grid Option -->
        <button (click)="setViewMode('grid')"
          class="w-10 h-full rounded-full flex items-center justify-center transition-all duration-300" [ngClass]="
            viewMode === 'grid' ? 'bg-maingoo-sage text-white shadow-sm' : 'text-gray-400 hover:text-gray-600'
          ">
          <app-icon name="grid_view" size="md"></app-icon>
        </button>
        <!-- List Option -->
        <button (click)="setViewMode('list')"
          class="w-10 h-full rounded-full flex items-center justify-center transition-all duration-300" [ngClass]="
            viewMode === 'list' ? 'bg-maingoo-sage text-white shadow-sm' : 'text-gray-400 hover:text-gray-600'
          ">
          <app-icon name="view_list" size="md"></app-icon>
        </button>
      </div>
    </div>

    <!-- SECTION: Header & Actions (Desktop Only) -->
    <app-section-header class="w-full hidden md:block" title="Proveedores" [viewMode]="viewMode"
      [showViewSwitcher]="supplier.length > 0" [showSearch]="supplier.length > 0"
      searchPlaceholder="Buscar un proveedor..." (viewModeChange)="setViewMode($any($event))"
      (search)="filterSuppliers($event)">
      <div actions>
        <button pButton label="Subir Factura" severity="primary" (click)="openAddInvoiceModal()">
          <app-icon name="receipt_long" size="md"></app-icon>
        </button>
      </div>
    </app-section-header>

    <!-- SECTION: Main Layout (Table/Grid) -->
    <div class="flex flex-row gap-6 w-full items-start">
      <!-- Left Side: Main Content -->
      <div class="flex-1 min-w-0">
        <!-- SECTION: Empty State -->
        <div *ngIf="!cargando && supplier.length === 0; else contenidoPrincipal">
          <app-empty-state icon="local_shipping" title="No hay proveedores registrados"
            description="Cuando escanees o subas una factura, ese proveedor, aparecerá aquí.">
          </app-empty-state>
        </div>

        <ng-template #contenidoPrincipal>
          <!-- LOADING: Skeleton Grid -->
          <ng-container *ngIf="cargando">
            <div *ngIf="viewMode === 'grid'" class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
              <div *ngFor="let i of [1,2,3,4,5,6,7,8]"
                class="rounded-xl overflow-hidden shadow-sm bg-white p-4 flex flex-col gap-3 min-h-[180px]">
                <div class="flex flex-col gap-2">
                  <p-skeleton width="70%" height="1.25rem"></p-skeleton>
                  <p-skeleton width="40%" height="0.75rem"></p-skeleton>
                </div>
                <div class="mt-auto flex flex-col gap-2">
                  <div class="flex items-center gap-2">
                    <p-skeleton shape="circle" size="1rem"></p-skeleton>
                    <p-skeleton width="60%" height="0.875rem"></p-skeleton>
                  </div>
                  <div class="flex items-center gap-2">
                    <p-skeleton shape="circle" size="1rem"></p-skeleton>
                    <p-skeleton width="50%" height="0.875rem"></p-skeleton>
                  </div>
                  <div class="flex items-center gap-2">
                    <p-skeleton shape="circle" size="1rem"></p-skeleton>
                    <p-skeleton width="45%" height="0.875rem"></p-skeleton>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="viewMode === 'list'" class="rounded-xl shadow-sm overflow-hidden bg-white">
              <div *ngFor="let i of [1,2,3,4,5,6]"
                class="border-b border-gray-100 last:border-0 p-4 flex items-center gap-4">
                <p-skeleton shape="circle" size="2.5rem"></p-skeleton>
                <div class="flex-1 flex flex-col gap-2">
                  <p-skeleton width="50%" height="1rem"></p-skeleton>
                  <p-skeleton width="30%" height="0.75rem"></p-skeleton>
                </div>
                <p-skeleton width="1rem" height="1rem"></p-skeleton>
              </div>
            </div>
          </ng-container>

          <!-- LOADED: Actual Content -->
          <ng-container *ngIf="!cargando">
            <!-- VIEW: Grid Mode -->
            <ng-container *ngIf="viewMode === 'grid'">
              <div class="grid gap-6"
                [ngClass]="selectedSupplier ? 'grid-cols-1' : 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-4'">
                <div *ngFor="let item of filteredSupplier"
                  class="rounded-xl overflow-hidden shadow-sm hover:shadow-lg ring-1 ring-transparent hover:ring-maingoo-sage transition-all duration-300 cursor-pointer group relative h-auto min-h-[180px] flex flex-col"
                  (click)="showDialog(item)">
                  <!-- Card Content -->
                  <div class="p-4 card text-maingoo-deep flex-1 flex flex-col gap-3">
                    <!-- Header: Name -->
                    <div class="flex flex-col mb-1">
                      <span class="font-bold text-lg truncate" [title]="item.name">{{ item.name }}</span>
                      <span class="text-xs text-gray-400 font-normal" *ngIf="item.sanitaryRegistrationNumber">{{
                        item.sanitaryRegistrationNumber
                        }}</span>
                      <span class="text-xs text-gray-300 italic font-normal"
                        *ngIf="!item.sanitaryRegistrationNumber">Sin
                        registro sanitario</span>
                    </div>

                    <!-- Details List -->
                    <div class="flex flex-col gap-2 text-sm text-gray-600">
                      <!-- Contact Name -->
                      <div class="flex items-center gap-2">
                        <app-icon name="person" size="xs" class="text-maingoo-sage w-4"></app-icon>
                        <span class="truncate" *ngIf="item.commercialName">{{ item.commercialName }}</span>
                        <span class="truncate text-gray-300 italic" *ngIf="!item.commercialName">Sin nombre
                          comercial</span>
                      </div>
                      <!-- Phone -->
                      <div class="flex items-center gap-2">
                        <app-icon name="phone" size="xs" class="text-maingoo-sage w-4"></app-icon>
                        <span class="truncate" *ngIf="item.phoneNumber">{{ item.phoneNumber }}</span>
                        <span class="truncate text-gray-300 italic" *ngIf="!item.phoneNumber">Sin teléfono</span>
                      </div>
                      <!-- Order Days -->
                      <div class="flex items-center gap-2">
                        <app-icon name="schedule" size="xs" class="text-maingoo-sage w-4"></app-icon>
                        <span class="truncate" *ngIf="item.orderDays">{{ item.orderDays }}</span>
                        <span class="truncate text-gray-300 italic" *ngIf="!item.orderDays">Sin días pedido</span>
                      </div>
                      <!-- Delivery Days -->
                      <div class="flex items-center gap-2">
                        <app-icon name="local_shipping" size="xs" class="text-maingoo-sage w-4"></app-icon>
                        <span class="truncate" *ngIf="item.deliveryDays">{{ item.deliveryDays }}</span>
                        <span class="truncate text-gray-300 italic" *ngIf="!item.deliveryDays">Sin días reparto</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- VIEW: List Mode -->
            <div *ngIf="viewMode === 'list'" class="rounded-xl shadow-sm overflow-hidden bg-white">
              <!-- Mobile Compact List View (Rows) -->
              <div class="flex flex-col md:hidden">
                <div *ngFor="let item of filteredSupplier" (click)="showDialog(item)"
                  class="border-b border-gray-100 last:border-0 p-3 flex items-center gap-3 active:bg-gray-50 transition-colors cursor-pointer relative"
                  [class.bg-maingoo-sage-50]="selectedSupplier?.id === item.id">
                  <!-- Avatar/Icon Compact -->
                  <div
                    class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center shrink-0 border border-gray-100">
                    <span class="text-maingoo-deep font-bold text-sm">{{ item.name.charAt(0).toUpperCase() }}</span>
                  </div>

                  <!-- Main Info Compact -->
                  <div class="flex-1 min-w-0 flex flex-col gap-0.5">
                    <div class="flex justify-between items-center">
                      <h3 class="font-semibold text-[#1A3C34] text-sm truncate pr-2">{{ item.name }}</h3>
                    </div>

                    <div class="flex items-center gap-2 text-xs text-gray-500">
                      <span *ngIf="item.commercialName" class="truncate flex items-center gap-1 min-w-0 max-w-[45%]">
                        <app-icon name="person" size="xs" class="text-maingoo-sage"></app-icon> {{ item.commercialName
                        }}
                      </span>
                      <span *ngIf="item.phoneNumber" class="truncate flex items-center gap-1 min-w-0">
                        <app-icon name="phone" size="xs" class="text-maingoo-sage"></app-icon> {{ item.phoneNumber }}
                      </span>
                    </div>
                  </div>

                  <!-- Chevron -->
                  <app-icon name="chevron_right" size="xs" class="text-gray-300"></app-icon>
                </div>
              </div>

              <!-- Desktop Table View -->
              <div class="hidden md:block">
                <p-table [value]="filteredSupplier" [rowHover]="true" styleClass="p-datatable-sm">
                  <ng-template pTemplate="header">
                    <tr>
                      <th class="text-maingoo-deep font-bold text-sm" [class.w-full]="selectedSupplier"
                        [class.w-[25%]]="!selectedSupplier">
                        Proveedor
                      </th>
                      <th class="text-maingoo-deep font-bold text-sm w-[15%]" *ngIf="!selectedSupplier">Comercial</th>
                      <th class="text-maingoo-deep font-bold text-sm w-[15%]" *ngIf="!selectedSupplier">Teléfono</th>
                      <th class="text-maingoo-deep font-bold text-sm w-[17.5%]" *ngIf="!selectedSupplier">Día Pedido
                      </th>
                      <th class="text-maingoo-deep font-bold text-sm w-[17.5%]" *ngIf="!selectedSupplier">Día Reparto
                      </th>
                      <th [class.w-[10%]]="!selectedSupplier" [class.w-auto]="selectedSupplier"></th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr class="cursor-pointer hover:/20 transition-colors border-l-4 border-transparent"
                      [ngClass]="{ '/10 !border-maingoo-sage': selectedSupplier?.id === item.id }"
                      (click)="showDialog(item)">
                      <!-- Column 1: Provider Name + Sanitary Reg -->
                      <td>
                        <div class="flex flex-col">
                          <span class="font-bold text-maingoo-deep text-base">{{ item.name }}</span>
                          <span class="text-xs text-gray-400 font-normal" *ngIf="item.sanitaryRegistrationNumber">{{
                            item.sanitaryRegistrationNumber
                            }}</span>
                          <span class="text-xs text-gray-300 italic font-normal"
                            *ngIf="!item.sanitaryRegistrationNumber">Sin registro sanitario</span>
                        </div>
                      </td>

                      <!-- Column 2: Contact Name (Persona) -->
                      <td *ngIf="!selectedSupplier">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                          <app-icon name="person" size="xs" class="text-maingoo-sage"></app-icon>
                          <span class="truncate max-w-[150px]" *ngIf="item.commercialName">{{
                            item.commercialName
                            }}</span>
                          <span class="truncate max-w-[150px] text-gray-300 italic" *ngIf="!item.commercialName">Sin
                            comercial</span>
                        </div>
                      </td>

                      <!-- Column 3: Phone -->
                      <td *ngIf="!selectedSupplier">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                          <app-icon name="phone" size="xs" class="text-maingoo-sage"></app-icon>
                          <span *ngIf="item.phoneNumber">{{ item.phoneNumber }}</span>
                          <span class="text-gray-300 italic" *ngIf="!item.phoneNumber">Sin teléfono</span>
                        </div>
                      </td>

                      <!-- Column 4: Order Day -->
                      <td *ngIf="!selectedSupplier">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                          <app-icon name="calendar_today" size="xs" class="text-maingoo-sage"></app-icon>
                          <span class="truncate max-w-[200px]" title="Pedidos" *ngIf="item.orderDays">{{
                            item.orderDays
                            }}</span>
                          <span class="truncate max-w-[200px] text-gray-300 italic" title="Pedidos"
                            *ngIf="!item.orderDays">Sin días pedido</span>
                        </div>
                      </td>

                      <!-- Column 5: Delivery Day -->
                      <td *ngIf="!selectedSupplier">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                          <app-icon name="local_shipping" size="xs" class="text-maingoo-sage"></app-icon>
                          <span class="truncate max-w-[200px]" title="Reparto" *ngIf="item.deliveryDays">{{
                            item.deliveryDays
                            }}</span>
                          <span class="truncate max-w-[200px] text-gray-300 italic" title="Reparto"
                            *ngIf="!item.deliveryDays">Sin días reparto</span>
                        </div>
                      </td>

                      <td class="text-right">
                        <button pButton
                          class="p-button-text p-button-secondary p-button-sm transition-transform duration-200"
                          [ngClass]="{ 'rotate-180 text-maingoo-sage': selectedSupplier?.id === item.id }">
                          <app-icon name="chevron_left" size="md"></app-icon>
                        </button>
                      </td>
                    </tr>
                  </ng-template>
                  <!-- Empty State in Table -->
                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="4" class="text-center py-8 text-gray-500">No se encontraron proveedores.</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>
          </ng-container>
        </ng-template>
      </div>

      <!-- SECTION: Sidebar/Detail Panel -->
      <ng-container *ngIf="selectedSupplier">
        <!-- DESKTOP: Side Panel (Sticky, In-Flow) -->
        <div
          class="hidden md:flex w-full md:w-3/4 shrink-0 sticky top-4 rounded-xl overflow-hidden shadow-2xl z-20 h- flex-col card">
          <ng-container *ngTemplateOutlet="detailContent"></ng-container>
        </div>

        <!-- MOBILE: Bottom Sheet (Fixed, Overlay) -->
        <div class="md:hidden fixed inset-0 z-50 flex items-end justify-center">
          <!-- Backdrop -->
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" (click)="hideDialog()"></div>

          <!-- Sheet -->
          <div
            class="relative w-full h-[85vh] bg-white rounded-t-3xl shadow-[0_-4px_30px_rgba(0,0,0,0.15)] flex flex-col animate-slide-up overflow-hidden">
            <!-- Drag Handle Area -->
            <div class="w-full flex justify-center pt-4 pb-2 bg-white shrink-0 cursor-grab active:cursor-grabbing"
              (click)="hideDialog()">
              <!-- Click on handle acts as close for simplicity or add swipe logic later -->
              <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>

            <!-- Content Wrapper -->
            <div class="flex-1 overflow-hidden relative flex flex-col">
              <ng-container *ngTemplateOutlet="detailContent"></ng-container>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- SHARED CONTENT TEMPLATE -->
    <ng-template #detailContent>
      <!-- Cover Image Area -->
      <div class="h-16 w-full relative shrink-0">
        <div class="absolute top-4 right-4 flex gap-2 items-center">
          <!-- Action Buttons -->
          <div class="flex gap-1">
            <button pButton class="p-button-rounded p-button-text"
              [ngClass]="isEditing ? 'p-button-success' : 'p-button-secondary'"
              [pTooltip]="isEditing ? 'Guardar cambios' : 'Editar proveedor'" tooltipPosition="bottom"
              (click)="editSupplier(selectedSupplier!)">
              <app-icon [name]="isEditing ? 'check' : 'edit'" size="md"></app-icon>
            </button>
            <button pButton class="p-button-rounded p-button-text p-button-danger" pTooltip="Eliminar proveedor"
              tooltipPosition="bottom" (click)="confirmDelete(selectedSupplier!)">
              <app-icon name="delete" size="md"></app-icon>
            </button>
          </div>

          <!-- Close Button -->
          <button
            class="p-button-rounded p-button-text text-gray-400 hover:bg-gray-100 hover:text-red-600 w-10 h-10 items-center justify-center flex transition-all duration-200"
            (click)="hideDialog()">
            <app-icon name="close" size="md"></app-icon>
          </button>
        </div>
      </div>

      <div class="px-6 pb-24 md:pb-8 relative flex-1 overflow-y-auto" (click)="showMenu = false">
        <!-- Title, Properties and Image -->
        <div class="mb-6 flex flex-col-reverse md:flex-row justify-between items-start gap-6">
          <div class="flex-1 pt-2 flex flex-col gap-2 w-full">
            <h1 class="text-2xl md:text-3xl font-bold text-maingoo-deep leading-tight break-words">
              {{ selectedSupplier?.name }}
            </h1>

            <!-- Helper for inline input -->
            <ng-template #inlineInput let-label="label" let-value="value" let-icon="icon">
              <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
                <div class="flex items-center gap-2 text-gray-400 text-sm">
                  <i [class]="'pi ' + icon + ' text-maingoo-sage'"></i>
                  <span>{{ label }}</span>
                </div>
                <div class="flex items-center">
                  <input type="text" [value]="value || ''" [readonly]="!isEditing" placeholder="Vacío"
                    class="bg-transparent border border-transparent text-maingoo-deep focus:outline-none rounded px-2 py-0.5 w-full -ml-2 transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm"
                    [ngClass]="{ 'hover:border-maingoo-sage/30 focus:border-maingoo-sage': isEditing }" />
                </div>
              </div>
            </ng-template>

            <!-- Unified Properties List -->
            <div class="flex flex-col gap-2 mt-2">
              <!-- Address -->
              <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]"
                *ngIf="selectedSupplier?.address">
                <div class="flex items-center gap-2 text-gray-400 text-sm">
                  <app-icon name="location_on" size="md" class="text-maingoo-sage"></app-icon>
                  <span>Dirección</span>
                </div>
                <div class="flex items-center -ml-2">
                  <input type="text" [(ngModel)]="selectedSupplier!.address" [readonly]="!isEditing" placeholder="Vacío"
                    class="bg-transparent border border-transparent text-maingoo-deep font-medium focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm"
                    [ngClass]="{ 'hover:border-maingoo-sage/30 focus:border-maingoo-sage': isEditing }" />
                </div>
              </div>

              <!-- Sanitary Registration & CIF/NIF Group -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Sanitary Registration -->
                <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
                  <div class="flex items-center gap-2 text-gray-400 text-sm">
                    <app-icon name="description" size="md" class="text-maingoo-sage"></app-icon>
                    <span>Reg. Sanitario</span>
                  </div>
                  <div class="flex items-center -ml-2">
                    <input type="text" [(ngModel)]="selectedSupplier!.sanitaryRegistrationNumber"
                      [readonly]="!isEditing" placeholder="Vacío"
                      class="bg-transparent border border-transparent text-maingoo-deep font-medium focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm"
                      [ngClass]="{ 'hover:border-maingoo-sage/30 focus:border-maingoo-sage': isEditing }" />
                  </div>
                </div>

                <!-- CIF/NIF -->
                <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
                  <div class="flex items-center gap-2 text-gray-400 text-sm">
                    <app-icon name="badge" size="md" class="text-maingoo-sage"></app-icon>
                    <span>CIF/NIF</span>
                  </div>
                  <div class="flex items-center -ml-2">
                    <input type="text" [(ngModel)]="selectedSupplier!.cifNif" [readonly]="!isEditing"
                      class="bg-transparent border border-transparent text-maingoo-deep font-medium focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm"
                      [ngClass]="{ 'hover:border-maingoo-sage/30 focus:border-maingoo-sage': isEditing }" />
                  </div>
                </div>
              </div>

              <!-- Contact & Delivery Grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                <!-- Contacto Comercial SECTION -->
                <div class="group">
                  <!-- Inline Toggle Header -->
                  <div class="grid grid-cols-[130px_1fr] items-center py-1 min-h-[32px] cursor-pointer"
                    (click)="!isEditing && (showContact = !showContact)">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                      <app-icon name="business_center" size="md" class="text-maingoo-sage"></app-icon>
                      <span>Contacto</span>
                    </div>
                    <div class="flex items-center">
                      <span *ngIf="!isEditing && hasEmptyContactFields" class="text-xs text-maingoo-sage/80 italic">
                        {{ showContact ? 'ocultar campos' : 'mostrar campos' }}
                      </span>
                    </div>
                  </div>

                  <div class="overflow-hidden transition-all duration-300 ease-in-out">
                    <div class="flex flex-col gap-1 py-1 pl-6">
                      <!-- Persona de contacto -->
                      <!-- Persona de contacto -->
                      <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]"
                        *ngIf="selectedSupplier?.commercialName || isEditing || showContact">
                        <div class="flex items-center gap-2 text-gray-400 text-sm">
                          <app-icon name="person" size="md" class="text-maingoo-sage"></app-icon>
                          <span>Persona</span>
                        </div>
                        <div class="flex items-center -ml-2">
                          <input type="text" [(ngModel)]="selectedSupplier!.commercialName" [readonly]="!isEditing"
                            placeholder="Vacío"
                            class="bg-transparent border border-transparent text-maingoo-deep focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm"
                            [ngClass]="{ 'hover:border-maingoo-sage/30 focus:border-maingoo-sage': isEditing }" />
                        </div>
                      </div>

                      <!-- Telefono -->
                      <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]"
                        *ngIf="selectedSupplier?.phoneNumber || isEditing || showContact">
                        <div class="flex items-center gap-2 text-gray-400 text-sm">
                          <app-icon name="phone" size="md" class="text-maingoo-sage"></app-icon>
                          <span>Teléfono</span>
                        </div>
                        <div class="flex items-center -ml-2">
                          <input type="text" [(ngModel)]="selectedSupplier!.phoneNumber" [readonly]="!isEditing"
                            placeholder="Vacío"
                            class="bg-transparent border border-transparent text-maingoo-deep focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm"
                            [ngClass]="{ 'hover:border-maingoo-sage/30 focus:border-maingoo-sage': isEditing }" />
                        </div>
                      </div>

                      <!-- Email -->
                      <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]"
                        *ngIf="selectedSupplier?.commercialEmail || isEditing || showContact">
                        <div class="flex items-center gap-2 text-gray-400 text-sm">
                          <app-icon name="mail" size="md" class="text-maingoo-sage"></app-icon>
                          <span>Email</span>
                        </div>
                        <div class="flex items-center -ml-2">
                          <input type="text" [(ngModel)]="selectedSupplier!.commercialEmail" [readonly]="!isEditing"
                            placeholder="Vacío"
                            class="bg-transparent border border-transparent text-maingoo-deep focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm"
                            [ngClass]="{ 'hover:border-maingoo-sage/30 focus:border-maingoo-sage': isEditing }" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Reparto SECTION -->
                <div class="group">
                  <!-- Inline Toggle Header -->
                  <div class="grid grid-cols-[130px_1fr] items-center py-1 min-h-[32px] cursor-pointer"
                    (click)="!isEditing && (showDelivery = !showDelivery)">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                      <app-icon name="local_shipping" size="md" class="text-maingoo-sage"></app-icon>
                      <span>Reparto</span>
                    </div>
                    <div class="flex items-center">
                      <span *ngIf="!isEditing && hasEmptyDeliveryFields" class="text-xs text-maingoo-sage/80 italic">
                        {{ showDelivery ? 'ocultar campos' : 'mostrar campos' }}
                      </span>
                    </div>
                  </div>

                  <div class="overflow-hidden transition-all duration-300 ease-in-out">
                    <div class="flex flex-col gap-1 py-1">
                      <div class="flex flex-col gap-1 pl-6">
                        <!-- Ultimo dia de pedido Chips -->
                        <div class="grid grid-cols-[130px_1fr] py-1 group min-h-[32px]"
                          *ngIf="selectedLastOrderDays.length > 0 || isEditing || showDelivery">
                          <div class="flex items-center gap-2 text-gray-400 text-sm h-8">
                            <app-icon name="calendar_today" size="md" class="text-maingoo-sage"></app-icon>
                            <span>Día de pedido</span>
                          </div>
                          <div class="flex flex-wrap gap-1 items-center -ml-2">
                            <div *ngFor="let day of daysOptions"
                              (click)="isEditing && toggleDay('lastOrder', day.value)"
                              class="px-2 py-1 rounded text-xs transition-colors border select-none shrink-0" [ngClass]="{
                                'cursor-pointer': isEditing,
                                'cursor-default': !isEditing,
                                'bg-maingoo-sage text-white border-maingoo-sage': isDaySelected('lastOrder', day.value),
                                'bg-gray-100 text-gray-500 border-transparent':
                                  !isDaySelected('lastOrder', day.value) && !isEditing,
                                'bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200':
                                  !isDaySelected('lastOrder', day.value) && isEditing
                              }">
                              {{ day.short }}
                            </div>
                          </div>
                        </div>

                        <!-- Dias de reparto Chips -->
                        <div class="grid grid-cols-[130px_1fr] py-1 group min-h-[32px]"
                          *ngIf="selectedDays.length > 0 || isEditing || showDelivery">
                          <div class="flex items-center gap-2 text-gray-400 text-sm h-8">
                            <app-icon name="local_shipping" size="md" class="text-maingoo-sage"></app-icon>
                            <span>Día de reparto</span>
                          </div>
                          <div class="flex flex-wrap gap-1 items-center -ml-2">
                            <div *ngFor="let day of daysOptions" (click)="isEditing && toggleDay('delivery', day.value)"
                              class="px-2 py-1 rounded text-xs transition-colors border select-none shrink-0" [ngClass]="{
                                'cursor-pointer': isEditing,
                                'cursor-default': !isEditing,
                                'bg-maingoo-sage text-white border-maingoo-sage': isDaySelected('delivery', day.value),
                                'bg-gray-100 text-gray-500 border-transparent':
                                  !isDaySelected('delivery', day.value) && !isEditing,
                                'bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200':
                                  !isDaySelected('delivery', day.value) && isEditing
                              }">
                              {{ day.short }}
                            </div>
                          </div>
                        </div>
                        <!-- Pedido minimo Inline -->
                        <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]" *ngIf="
                            (selectedSupplier!.minPriceDelivery !== null &&
                              selectedSupplier!.minPriceDelivery !== undefined) ||
                            isEditing ||
                            showDelivery
                          ">
                          <div class="flex items-center gap-2 text-gray-400 text-sm">
                            <app-icon name="euro" size="md" class="text-maingoo-sage"></app-icon>
                            <span>Pedido mín.</span>
                          </div>
                          <div class="flex items-center -ml-2">
                            <div class="flex items-center w-full">
                              <p-inputNumber [(ngModel)]="selectedSupplier!.minPriceDelivery" mode="currency"
                                currency="EUR" locale="es-ES" placeholder="0,00 €" [minFractionDigits]="2"
                                [maxFractionDigits]="2" styleClass="w-24" [disabled]="!isEditing"
                                inputStyleClass="bg-transparent border-b border-gray-200 hover:border-maingoo-sage focus:border-maingoo-sage text-maingoo-deep font-medium focus:outline-none px-1 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm !shadow-none !rounded-none">
                              </p-inputNumber>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Image Placeholder -->
          <div
            class="w-40 h-40 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center shrink-0 overflow-hidden shadow-sm self-center md:self-auto">
            <app-icon name="image" size="2xl" class="text-gray-300"></app-icon>
          </div>
        </div>

        <!-- Statistics Section -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div (click)="showStats = !showStats"
            class="flex justify-between items-center cursor-pointer group select-none">
            <h3
              class="text-xs text-maingoo-deep/60 uppercase tracking-wider font-semibold group-hover:text-maingoo-sage transition-colors">
              Estadísticas
            </h3>
            <app-icon name="expand_more"
              class="text-gray-400 group-hover:text-maingoo-sage transition-transform duration-300"
              [ngClass]="{ 'rotate-180': showStats }" size="md"></app-icon>
          </div>

          <div class="overflow-hidden transition-all duration-300 ease-in-out"
            [style.max-height]="showStats ? '1000px' : '0'">
            <div class="pt-4 px-3 pb-4 grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Monthly Expense Chart -->
              <div>
                <div class="flex justify-between items-center mb-2 min-h-[32px]">
                  <h4 class="text-xs font-bold text-gray-400 uppercase">Gasto Mensual</h4>
                  <p-dropdown [options]="availableYears" [(ngModel)]="selectedYear" (onChange)="onYearChange()"
                    optionLabel="label" optionValue="value"
                    styleClass="border-none bg-transparent p-0 text-maingoo-deep font-bold text-sm min-w-[80px]"
                    [panelStyle]="{ 'font-size': '14px' }">
                  </p-dropdown>
                </div>
                <div class="h-48" *ngIf="supplierInvoices.length > 0">
                  <p-chart type="bar" [data]="chartData" [options]="chartOptions" height="100%"></p-chart>
                </div>
              </div>

              <!-- Historical Chart -->
              <div *ngIf="supplierInvoices.length > 0">
                <div class="flex justify-between items-center mb-2 min-h-[32px]">
                  <h4 class="text-xs font-bold text-gray-400 uppercase">Histórico</h4>
                </div>
                <div class="h-48">
                  <p-chart type="bar" [data]="historyChartData" [options]="chartOptions" height="100%"></p-chart>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Invoices Section -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div (click)="showInvoices = !showInvoices"
            class="flex justify-between items-center cursor-pointer group select-none">
            <h3
              class="text-xs text-maingoo-deep/60 uppercase tracking-wider font-semibold group-hover:text-maingoo-sage transition-colors">
              Facturas Asociadas
            </h3>
            <app-icon name="expand_more"
              class="text-gray-400 group-hover:text-maingoo-sage transition-transform duration-300"
              [ngClass]="{ 'rotate-180': showInvoices }" size="md"></app-icon>
          </div>

          <div class="overflow-hidden transition-all duration-300 ease-in-out"
            [style.max-height]="showInvoices ? '500px' : '0'">
            <div class="pt-4 flex flex-col gap-2">
              <!-- Loading State -->
              <div *ngIf="supplierInvoices.length === 0 && !selectedSupplier"
                class="text-center py-4 text-gray-400 text-sm">
                Cargando facturas...
              </div>

              <!-- No Invoices -->
              <div *ngIf="supplierInvoices.length === 0" class="text-gray-400 text-sm italic py-2">
                No hay facturas registradas.
              </div>

              <!-- Invoice List -->
              <div *ngFor="let invoice of supplierInvoices"
                class="flex items-center justify-between p-3 rounded-lg border border-transparent hover:border-maingoo-sage transition-colors cursor-pointer group relative"
                (click)="viewInvoice(invoice)" pTooltip="Ver factura" tooltipPosition="top">
                <div class="flex items-center gap-3">
                  <div
                    class="w-8 h-8 rounded-full bg-white text-maingoo-sage flex items-center justify-center border border-maingoo-sage/10">
                    <app-icon name="description" size="sm"></app-icon>
                  </div>
                  <div class="flex flex-col">
                    <span
                      class="text-maingoo-deep text-sm font-medium group-hover:text-maingoo-sage transition-colors">{{
                      invoice.invoiceNumber || 'Sin número' }}</span>
                    <span class="text-gray-500 text-xs">{{ invoice.date | date: 'dd/MM/yyyy' }}</span>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="text-maingoo-deep font-bold text-sm block">{{ invoice.amount | currency: 'EUR' }}</span>
                  <button pButton
                    class="p-button-rounded p-button-text p-button-sm text-maingoo-sage hover:bg-white md:hidden"
                    (click)="viewInvoice(invoice); $event.stopPropagation()">
                    <app-icon name="visibility" size="sm"></app-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <style>
        @keyframes slide-in-right {
          from {
            transform: translateX(100%);
            opacity: 0;
          }

          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        .animate-slide-in-right {
          animation: slide-in-right 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slide-up {
          from {
            transform: translateY(100%);
            opacity: 0.5;
          }

          to {
            transform: translateY(0);
            opacity: 1;
          }
        }

        .animate-slide-up {
          animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
      </style>
    </ng-template>
  </div>

  <!-- Mobile FAB (Floating Action Button) -->
  <button
    class="md:hidden fixed bottom-24 right-6 w-14 h-14 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] text-white shadow-[0_4px_20px_rgba(26,60,52,0.25)] flex items-center justify-center active:scale-95 transition-all z-10 hover:shadow-[0_8px_24px_rgba(26,60,52,0.35)] hover:bg-[#15322b] dark:hover:bg-[#5a8671]"
    (click)="openAddInvoiceModal()" pTooltip="Subir factura" tooltipPosition="left" aria-label="Añadir factura">
    <app-icon name="add" size="xl"></app-icon>
  </button>
</div>