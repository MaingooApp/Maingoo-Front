<div class="flex gap-6 relative items-start bg-maingoo-mint min-h-screen p-6 -m-6">
  
  <!-- Left Side: Main Content (Table + Grid) -->
  <div class="flex-1 min-w-0 transition-all duration-300">
    
    <div *ngIf="supplier.length === 0; else tablaSupplier" class="card rounded-xl p-10 shadow-md text-center">
      <i class="pi pi-inbox text-gray-300 mb-6" style="font-size: 6rem"></i>
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">No hay proveedores registrados</h2>
      <p class="text-gray-500">Cuando registres un proveedor, aparecerá aquí.</p>
    </div>

    <ng-template #tablaSupplier>
      <!-- Header Card with Search -->
      <div class="bg-white rounded-xl shadow-sm p-4 mb-6 relative flex items-center justify-center border border-gray-100">
          <h2 class="text-2xl font-bold text-maingoo-deep absolute left-6">Proveedores</h2>
          
          <input type="text" 
                 pInputText 
                 placeholder="Buscar proveedor..." 
                 (input)="filterSuppliers($event)" 
                 class="border-gray-200 rounded-lg focus:border-maingoo-sage focus:ring-maingoo-sage w-64 placeholder:text-gray-400 placeholder:text-base text-left">
      </div>

      <!-- Grid View -->
      <div class="grid gap-4 transition-all duration-300" 
           [ngClass]="selectedSupplier ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4'">
        <div *ngFor="let item of filteredSupplier" 
             class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg ring-1 ring-transparent hover:ring-maingoo-sage transition-all duration-300 cursor-pointer group relative"
             (click)="showDialog(item)">


          <!-- Card Banner / Image Placeholder -->
          <div class="h-32 bg-gradient-to-br from-maingoo-deep to-maingoo-sage flex items-center justify-center p-4 relative">
                <!-- Generating a pseudo-logo based on name initials -->
                <span class="text-4xl font-bold text-white/90 select-none">
                  {{ item.commercialName?.charAt(0) || item.name.charAt(0) | uppercase }}
                </span>
          </div>

          <!-- Card Content -->
          <div class="p-4 bg-white text-maingoo-deep">
              <div class="flex items-center gap-3">
                  <i class="pi pi-box text-maingoo-sage text-xl"></i>
                  <div class="flex flex-col overflow-hidden">
                      <span class="font-bold text-lg truncate" [title]="item.commercialName || item.name">
                          {{ item.commercialName || item.name }}
                      </span>
                      <span class="text-sm text-gray-500 truncate" *ngIf="item.commercialName && item.name !== item.commercialName">
                          {{ item.name }}
                      </span>
                  </div>
              </div>
              <!-- Optional: Add more details if needed, e.g. phone -->
              <div class="mt-2 text-sm text-gray-500 flex items-center gap-2" *ngIf="item.phoneNumber">
                  <i class="pi pi-phone text-xs text-maingoo-sage"></i>
                  {{ item.phoneNumber }}
              </div>
          </div>
        </div>
      </div>
    </ng-template>

  </div>

  <!-- Right Side: Detail Panel (Sticky) -->
  <div *ngIf="selectedSupplier" 
       class="w-full md:w-1/2 shrink-0 sticky top-4 rounded-xl overflow-hidden shadow-2xl bg-white border border-gray-100 transition-all duration-300 animate-slide-in-right z-20 h-[calc(100vh-2rem)] flex flex-col">
    
      <!-- Cover Image Area -->
      <div class="h-32 bg-gradient-to-r from-maingoo-deep to-maingoo-sage w-full relative shrink-0">
        <div class="absolute top-4 right-4 flex gap-2 items-center">
           
           <!-- Hamburger Menu -->
           <div class="relative">
              <button pButton icon="pi pi-ellipsis-v" class="p-button-rounded p-button-text text-white/70 hover:text-white" (click)="toggleMenu($event)"></button>
              
              <!-- Dropdown Menu -->
              <div *ngIf="showMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-xl py-1 z-50 border border-gray-100 overflow-hidden animate-fade-in origin-top-right">
                  <button (click)="downloadSupplier()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-maingoo-mint hover:text-maingoo-deep flex items-center gap-2 transition-colors">
                      <i class="pi pi-download"></i>
                      Descargar información
                  </button>
                  <div class="h-px bg-gray-100 my-1"></div>
                  <button (click)="handleAccionProveedor({action: 'eliminar', row: selectedSupplier})" class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors">
                      <i class="pi pi-trash"></i>
                      Eliminar
                  </button>
              </div>
           </div>

           <!-- Close Button -->
           <button pButton icon="pi pi-times" class="p-button-rounded p-button-text text-white/70 hover:text-white" (click)="hideDialog()"></button>
        </div>
      </div>

      <div class="px-6 pb-8 relative pt-6 flex-1 overflow-y-auto" (click)="showMenu = false">

         <!-- Title -->
         <div class="mb-6">
             <h1 class="text-3xl font-bold text-maingoo-deep leading-tight break-words">{{ selectedSupplier.commercialName || selectedSupplier.name }}</h1>
         </div>

         <!-- Helper for inline input -->
         <ng-template #inlineInput let-label="label" let-value="value" let-icon="icon">
             <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
               <div class="flex items-center gap-2 text-gray-400 text-sm">
                 <i [class]="'pi ' + icon + ' text-maingoo-sage'"></i>
                 <span>{{ label }}</span>
               </div>
               <div class="flex items-center">
                 <input type="text" 
                        [value]="value || ''" 
                        placeholder="Vacío"
                        class="bg-transparent border border-transparent hover:border-maingoo-sage/30 focus:border-maingoo-sage text-maingoo-deep focus:outline-none rounded px-2 py-0.5 w-full -ml-2 transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm">
               </div>
             </div>
         </ng-template>

         <!-- Unified Properties List -->
         <div class="flex flex-col gap-2">
             <!-- Address -->
             <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]" *ngIf="selectedSupplier.address">
                 <div class="flex items-center gap-2 text-gray-400 text-sm">
                     <i class="pi pi-map-marker text-maingoo-sage"></i>
                     <span>Dirección</span>
                 </div>
                 <div class="flex items-center -ml-2">
                     <span class="text-maingoo-deep font-medium border-b border-transparent hover:border-maingoo-sage/30 transition-colors px-2 py-0.5 text-sm w-full truncate">{{ selectedSupplier.address }}</span>
                 </div>
             </div>
             
             <!-- Sanitary Registration -->
             <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
                 <div class="flex items-center gap-2 text-gray-400 text-sm">
                     <i class="pi pi-file text-maingoo-sage"></i>
                     <span>Reg. Sanitario</span>
                 </div>
                 <div class="flex items-center -ml-2">
                     <input type="text"
                            [value]="selectedSupplier.sanitaryRegistrationNumber || ''"
                            placeholder="Vacío"
                            class="bg-transparent border border-transparent hover:border-maingoo-sage/30 focus:border-maingoo-sage text-maingoo-deep font-medium focus:outline-none rounded px-2 py-0.5 w-full transition-all placeholder:text-gray-400 placeholder:italic text-sm focus:bg-white focus:shadow-sm">
                 </div>
             </div>

             <!-- CIF/NIF -->
             <div class="grid grid-cols-[130px_1fr] items-center py-1 group min-h-[32px]">
                 <div class="flex items-center gap-2 text-gray-400 text-sm">
                     <i class="pi pi-id-card text-maingoo-sage"></i>
                     <span>CIF/NIF</span>
                 </div>
                 <div class="flex items-center -ml-2">
                     <span class="text-maingoo-deep font-medium text-sm px-2 py-0.5">{{ selectedSupplier.cifNif || 'Vacío' }}</span>
                 </div>
             </div>

             <!-- Contacto Comercial SECTION -->
             <div class="group">
                <!-- Inline Toggle Header -->
                <div class="grid grid-cols-[130px_1fr] items-center py-1 min-h-[32px] cursor-pointer" (click)="showContact = !showContact">
                     <div class="flex items-center gap-2 text-gray-400 text-sm">
                         <i class="pi pi-briefcase text-maingoo-sage"></i>
                         <span>Contacto</span>
                     </div>
                     <div class="flex items-center">
                        <p-inputSwitch [(ngModel)]="showContact" (click)="$event.stopPropagation()" styleClass="scale-75"></p-inputSwitch>
                     </div>
                </div>

                <div class="overflow-hidden transition-all duration-300 ease-in-out" 
                     [style.max-height]="showContact ? '500px' : '0'"
                     [style.opacity]="showContact ? '1' : '0'">
                     <div class="flex flex-col gap-1 py-1">
                         <!-- Persona de contacto -->
                         <ng-container *ngTemplateOutlet="inlineInput; context: {label: 'Persona', icon: 'pi-user', value: ''}"></ng-container>
                         
                         <!-- Telefono -->
                         <ng-container *ngTemplateOutlet="inlineInput; context: {label: 'Teléfono', icon: 'pi-phone', value: selectedSupplier.phoneNumber}"></ng-container>
                         
                         <!-- Email -->
                         <ng-container *ngTemplateOutlet="inlineInput; context: {label: 'Email', icon: 'pi-envelope', value: ''}"></ng-container>
                     </div>
                </div>
             </div>


             <!-- Reparto SECTION -->
             <div class="group">
                <!-- Inline Toggle Header -->
                <div class="grid grid-cols-[130px_1fr] items-center py-1 min-h-[32px] cursor-pointer" (click)="showDelivery = !showDelivery">
                     <div class="flex items-center gap-2 text-gray-400 text-sm">
                         <i class="pi pi-truck text-maingoo-sage"></i>
                         <span>Reparto</span>
                     </div>
                     <div class="flex items-center">
                        <p-inputSwitch [(ngModel)]="showDelivery" (click)="$event.stopPropagation()" styleClass="scale-75"></p-inputSwitch>
                     </div>
                </div>

                <div class="overflow-hidden transition-all duration-300 ease-in-out" 
                     [style.max-height]="showDelivery ? '500px' : '0'"
                     [style.opacity]="showDelivery ? '1' : '0'">
                     <div class="flex flex-col gap-1 py-1">
                       <!-- Ultimo dia de pedido Chips -->
                       <div class="grid grid-cols-[130px_1fr] py-1 group min-h-[32px]">
                          <div class="flex items-center gap-2 text-gray-400 text-sm h-8">
                              <i class="pi pi-clock text-maingoo-sage"></i>
                              <span>Día de pedido</span>
                          </div>
                          <div class="flex flex-wrap gap-1 items-center -ml-2">
                              <div *ngFor="let day of daysOptions" 
                                   (click)="toggleDay('lastOrder', day.value)"
                                   class="px-2 py-1 rounded text-xs cursor-pointer transition-colors border select-none"
                                   [ngClass]="{
                                      'bg-maingoo-sage text-white border-maingoo-sage': isDaySelected('lastOrder', day.value),
                                      'bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200': !isDaySelected('lastOrder', day.value)
                                   }">
                                  {{ day.short }}
                              </div>
                          </div>
                       </div>

                       <!-- Dias de reparto Chips -->
                       <div class="grid grid-cols-[130px_1fr] py-1 group min-h-[32px]">
                          <div class="flex items-center gap-2 text-gray-400 text-sm h-8">
                              <i class="pi pi-calendar text-maingoo-sage"></i>
                              <span>Día de reparto</span>
                          </div>
                          <div class="flex flex-wrap gap-1 items-center -ml-2">
                              <div *ngFor="let day of daysOptions" 
                                   (click)="toggleDay('delivery', day.value)"
                                   class="px-2 py-1 rounded text-xs cursor-pointer transition-colors border select-none"
                                   [ngClass]="{
                                      'bg-maingoo-sage text-white border-maingoo-sage': isDaySelected('delivery', day.value),
                                      'bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200': !isDaySelected('delivery', day.value)
                                   }">
                                  {{ day.short }}
                              </div>
                          </div>
                       </div>

                         
                         <!-- Pedido minimo Nested Toggle -->
                         <div class="group">
                            <div class="grid grid-cols-[130px_1fr] items-center py-1 min-h-[32px] cursor-pointer" (click)="showMinOrder = !showMinOrder">
                                 <div class="flex items-center gap-2 text-gray-400 text-sm">
                                     <i class="pi pi-euro text-maingoo-sage"></i>
                                     <span>Pedido mín.</span>
                                 </div>
                                 <div class="flex items-center">
                                    <p-inputSwitch [(ngModel)]="showMinOrder" (click)="$event.stopPropagation()" styleClass="scale-75"></p-inputSwitch>
                                 </div>
                            </div>

                            <div class="overflow-hidden transition-all duration-300 ease-in-out" 
                                 [style.max-height]="showMinOrder ? '500px' : '0'"
                                 [style.opacity]="showMinOrder ? '1' : '0'">
                                 <div class="flex flex-col gap-1 py-1">
                                     <!-- Cantidad Input -->
                                     <ng-container *ngTemplateOutlet="inlineInput; context: {label: 'Cantidad', icon: 'pi-tag', value: selectedSupplier.minPriceDelivery ? selectedSupplier.minPriceDelivery + '€' : ''}"></ng-container>
                                 </div>
                            </div>
                         </div>
                     </div>
                </div>
             </div>

        </div>

        <!-- Invoices Section -->
        <div class="mt-8 border-t border-gray-200 pt-6">
           <div (click)="showInvoices = !showInvoices" class="flex justify-between items-center cursor-pointer group select-none">
              <h3 class="text-xs text-maingoo-deep/60 uppercase tracking-wider font-semibold group-hover:text-maingoo-sage transition-colors">Facturas Asociadas</h3>
              <i class="pi pi-chevron-down text-gray-400 group-hover:text-maingoo-sage transition-transform duration-300" [ngClass]="{'rotate-180': showInvoices}"></i>
           </div>
           
           <div class="overflow-hidden transition-all duration-300 ease-in-out" [style.max-height]="showInvoices ? '500px' : '0'">
              <div class="pt-4 flex flex-col gap-2">
                 
                 <!-- Loading State -->
                 <div *ngIf="supplierInvoices.length === 0 && !selectedSupplier" class="text-center py-4 text-gray-400 text-sm">
                    Cargando facturas...
                 </div>

                 <!-- No Invoices -->
                 <div *ngIf="supplierInvoices.length === 0" class="text-gray-400 text-sm italic py-2">
                    No hay facturas registradas.
                 </div>

                 <!-- Invoice List -->
                 <div *ngFor="let invoice of supplierInvoices" class="flex items-center justify-between p-3 bg-maingoo-mint rounded-lg border border-transparent hover:border-maingoo-sage transition-colors cursor-pointer group">
                    <div class="flex items-center gap-3">
                       <div class="w-8 h-8 rounded-full bg-white text-maingoo-sage flex items-center justify-center border border-maingoo-sage/10">
                          <i class="pi pi-file text-sm"></i>
                       </div>
                       <div class="flex flex-col">
                          <span class="text-maingoo-deep text-sm font-medium group-hover:text-maingoo-sage transition-colors">{{ invoice.invoiceNumber || 'Sin número' }}</span>
                          <span class="text-gray-500 text-xs">{{ invoice.date | date:'dd/MM/yyyy' }}</span>
                       </div>
                    </div>
                    <div class="text-right">
                       <span class="text-maingoo-deep font-bold text-sm block">{{ invoice.amount | currency:'EUR' }}</span>
                    </div>
                 </div>

              </div>
           </div>
        </div>

        <!-- Statistics Section -->
        <div class="mt-8 border-t border-gray-200 pt-6">
           <div (click)="showStats = !showStats" class="flex justify-between items-center cursor-pointer group select-none">
              <h3 class="text-xs text-maingoo-deep/60 uppercase tracking-wider font-semibold group-hover:text-maingoo-sage transition-colors">Estadísticas</h3>
              <i class="pi pi-chevron-down text-gray-400 group-hover:text-maingoo-sage transition-transform duration-300" [ngClass]="{'rotate-180': showStats}"></i>
           </div>
           
           <div class="overflow-hidden transition-all duration-300 ease-in-out" [style.max-height]="showStats ? '1000px' : '0'">
              <div class="pt-4 px-3 pb-4">
                 <!-- Monthly Expense Chart -->
                 <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Año en curso</h4>
                 <div class="h-48" *ngIf="supplierInvoices.length > 0">
                     <p-chart type="bar" [data]="chartData" [options]="chartOptions" height="100%"></p-chart>
                 </div>

                 <!-- Historical Chart -->
                 <div class="mt-6" *ngIf="supplierInvoices.length > 0">
                     <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Histórico</h4>
                     <div class="h-48">
                         <p-chart type="bar" [data]="historyChartData" [options]="chartOptions" height="100%"></p-chart>
                     </div>
                 </div>
              </div>
           </div>
        </div>

      </div>
  </div>

</div>

<style>
@keyframes slide-in-right {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
.animate-slide-in-right {
  animation: slide-in-right 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}
</style>
