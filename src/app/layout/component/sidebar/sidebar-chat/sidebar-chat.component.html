<!-- ========== SECCIÓN CHAT ========== -->

<!-- Área de mensajes expandida -->
<div id="chat-messages-expanded" class="flex-1 min-h-0 p-4 overflow-y-auto bg-[#F0F7F4] dark:bg-surface-800"
	[class.hidden]="isCompactMode">
	<!-- Mensajes dinámicos -->
	@for (message of messages; track message.id; let idx = $index) {
	@if (message.sender === 'bot') {
	<!-- Mensaje del BOT -->
	<div class="flex items-start space-x-2 mb-3 animate-[fadeIn_0.3s_ease-out]">
		<div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
			<img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
		</div>
		<div
			class="max-w-[80%] bg-white dark:bg-surface-700 text-gray-800 dark:text-surface-0 shadow-sm rounded-2xl rounded-tl-none p-3">
			<p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
		</div>
	</div>
	} @else {
	<!-- Mensaje del USUARIO -->
	<div class="flex items-start space-x-2 mb-3 justify-end animate-[fadeIn_0.3s_ease-out]">
		<div class="max-w-[80%] bg-[#6B9E86] dark:bg-[#1A3C34] text-white shadow-sm rounded-2xl rounded-tr-none p-3">
			<p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
		</div>
		<div class="w-6 h-6 bg-[#1A3C34] dark:bg-[#6B9E86] rounded-full flex items-center justify-center flex-shrink-0">
			<app-icon name="person" size="xs" class="text-white"></app-icon>
		</div>
	</div>
	}
	}

	<!-- Indicador de escritura -->
	@if (isTyping) {
	<div class="flex items-start space-x-2 mb-3">
		<div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
			<img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
		</div>
		<div class="bg-white dark:bg-surface-700 rounded-2xl rounded-tl-none p-3 shadow-sm">
			<div class="flex space-x-1">
				<div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce"></div>
				<div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.1s]"></div>
				<div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.2s]"></div>
			</div>
		</div>
	</div>
	}
</div>

<!-- Spacer para modo compacto -->
<div class="flex-1 bg-[#F0F7F4] dark:bg-surface-800" [class.hidden]="!isCompactMode"></div>

<!-- Acciones rápidas -->
<div class="flex-shrink-0 px-4 py-3 bg-[#F0F7F4] dark:bg-surface-800">
	<div class="grid grid-cols-2 gap-2">
		@for (action of currentContext.actions; track action.label) {
		<button (click)="handleQuickAction(action.action)"
			class="px-3 py-2.5 bg-[#6B9E86]/10 dark:bg-[#6B9E86]/20 text-[#1A3C34] dark:text-[#6B9E86] text-[11px] font-medium rounded-full hover:bg-[#6B9E86]/20 dark:hover:bg-[#6B9E86]/30 transition-all duration-200 flex items-center justify-center gap-1.5 text-center">
			<app-icon [name]="action.icon" size="xs"></app-icon>
			<span class="truncate">{{ action.label }}</span>
		</button>
		}
	</div>
</div>

<!-- Input de mensaje expandido -->
<div class="flex-shrink-0 p-4 bg-[#F0F7F4] dark:bg-surface-800">
	<div class="flex items-center gap-3">
		<!-- Botón de adjuntar con menú desplegable -->
		<div class="relative" id="attachment-menu-container">
			<button (click)="showAttachmentMenu = !showAttachmentMenu" [disabled]="isTyping"
				class="flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/50 dark:hover:bg-surface-700/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
				aria-label="Adjuntar archivo">
				<app-icon name="attach_file" size="md" class="text-[#6B9E86] dark:text-[#8BC4A8]"></app-icon>
			</button>

			<!-- Menú desplegable -->
			@if (showAttachmentMenu) {
			<div
				class="absolute bottom-full left-0 mb-2 bg-white dark:bg-surface-900 rounded-xl shadow-lg border border-gray-200 dark:border-surface-700 py-2 min-w-[160px] z-50">
				<button (click)="handleCameraCapture(); showAttachmentMenu = false"
					class="w-full px-4 py-2 text-left text-sm text-[#1A3C34] dark:text-surface-0 hover:bg-[#F0F7F4] dark:hover:bg-surface-700 flex items-center gap-3 transition-colors">
					<app-icon name="photo_camera" size="md" class="text-[#6B9E86] dark:text-[#8BC4A8]"></app-icon>
					<span>Tomar foto</span>
				</button>
				<button (click)="handleFileUpload(); showAttachmentMenu = false"
					class="w-full px-4 py-2 text-left text-sm text-[#1A3C34] dark:text-surface-0 hover:bg-[#F0F7F4] dark:hover:bg-surface-700 flex items-center gap-3 transition-colors">
					<app-icon name="upload_file" size="md" class="text-[#6B9E86] dark:text-[#8BC4A8]"></app-icon>
					<span>Subir archivo</span>
				</button>
			</div>
			}
		</div>

		<!-- Input de archivo oculto para cámara -->
		<input #cameraInput type="file" accept="image/*" capture="environment" (change)="onCameraCapture($event)"
			class="hidden" />

		<!-- Input de archivo oculto para subir archivos -->
		<input #fileInput type="file" accept="image/*,application/pdf" (change)="onFileSelected($event)"
			class="hidden" />

		<textarea #messageInput [(ngModel)]="messageText" (keydown)="handleKeyDown($event)" (input)="autoResize()"
			(focus)="onChatInputFocus()" [placeholder]="currentContext.placeholder" [maxlength]="maxMessageLength"
			rows="1"
			class="flex-1 px-3 py-2 border-0 outline-none text-sm bg-white/50 dark:bg-surface-700/50 rounded-2xl placeholder:text-gray-500 dark:placeholder:text-gray-400 text-[#1A3C34] dark:text-surface-0 resize-none overflow-hidden max-h-32">
    </textarea>

		<!-- Botón de enviar circular -->
		<button (click)="sendMessage()" [disabled]="!messageText.trim() || isTyping"
			class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
			aria-label="Enviar mensaje">
			<app-icon name="send" size="md" class="text-white dark:text-[#1A3C34]"></app-icon>
		</button>
	</div>

	@if (messageText.length > 300) {
	<div class="text-xs text-right mt-2 px-2 text-gray-600 dark:text-gray-400"
		[class.!text-red-500]="messageText.length >= maxMessageLength">
		{{ messageText.length }} / {{ maxMessageLength }}
	</div>
	}
</div>