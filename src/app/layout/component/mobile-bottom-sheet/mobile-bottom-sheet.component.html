<!-- Backdrop oscuro (solo visible en estado expanded) -->
<div
  class="bottom-sheet-backdrop"
  [class.active]="isDarkOverlay"
  (click)="onBackdropClick()"
  role="presentation"
  [attr.aria-hidden]="!isDarkOverlay"></div>

<!-- Contenedor del Bottom Sheet -->
<div
  #sheetContainer
  class="bottom-sheet-container"
  [class.minimized]="isMinimized"
  [class.compact]="isCompact"
  [class.expanded]="isExpanded"
  [style.height]="sheetHeight"
  (touchstart)="onTouchStart($event)"
  (touchmove)="onTouchMove($event)"
  (touchend)="onTouchEnd($event)"
  role="dialog"
  [attr.aria-modal]="isExpanded"
  [attr.aria-label]="currentContext.title">
  <!-- Botón Flotante de Menú (Solo visible en Minimized) -->
  <div class="menu-trigger-container" *ngIf="isMinimized">
    <button class="menu-float-button" (click)="expandFromMinimized($event)">
      <span class="font-medium">Menú</span>
      <i class="pi pi-angle-up animate-bounce"></i>
    </button>
  </div>

  <!-- Contenido Principal del Sheet (Oculto en Minimized) -->
  <div class="sheet-main-content" [class.hidden]="isMinimized">
    <!-- Handle / Drag Indicator -->
    <!-- Handle / Drag Indicator -->
    <div
      class="sheet-handle"
      (click)="onHeaderClick($event)"
      role="button"
      tabindex="0"
      aria-label="Cambiar estado del panel">
      <div class="handle-bar"></div>
    </div>

    <!-- Contenido del Sheet -->
    <div class="sheet-content">
      <!-- Estado Compacto: Botones y Chat Bar -->
      <div class="compact-view" *ngIf="isCompact">
        <div class="compact-content">
          <div class="grid grid-cols-3 gap-2">
            <button
              *ngFor="let link of quickLinks"
              (click)="navigateTo(link.route, $event)"
              [attr.aria-label]="'Navegar a ' + link.label"
              type="button"
              class="flex items-center justify-center gap-2 px-3 py-3 bg-white dark:bg-surface-700 text-[#1A3C34] dark:text-surface-0 rounded-full border-0 shadow-[0_2px_8px_rgba(26,60,52,0.05)] hover:text-[#6B9E86] hover:shadow-[0_4px_12px_rgba(26,60,52,0.1)] transition-all duration-200 cursor-pointer">
              <i [class]="link.icon + ' text-lg'" aria-hidden="true"></i>
              <span class="text-sm font-medium whitespace-nowrap">{{ link.label }}</span>
            </button>
          </div>
        </div>

        <!-- Input fake para expandir -->
        <div class="input-container-compact" (click)="onChatBarClick()">
          <div
            class="flex-1 px-4 py-3 bg-white dark:bg-surface-700 border-0 outline-0 text-sm text-gray-500 dark:text-gray-400 rounded-full shadow-sm flex items-center">
            {{ currentContext.placeholder }}
          </div>
          <button
            type="button"
            aria-label="Abrir chat"
            class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center text-white dark:text-[#1A3C34]">
            <i class="pi pi-send text-sm" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Estado Expandido: Conversación completa -->
      <div class="expanded-view" *ngIf="isExpanded">
        <!-- Header con título y botón de cerrar -->
        <div
          class="px-4 py-3 bg-[#F0F7F4] dark:bg-surface-800 border-b border-gray-200 dark:border-surface-700 flex justify-between items-center">
          <!-- Etiqueta CHAT -->
          <div>
            <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">
              Maingoo AI
            </p>
          </div>

          <!-- Botón de colapsar -->
          <button
            type="button"
            (click)="closeChat($event)"
            class="w-8 h-8 flex items-center justify-center rounded-full bg-white dark:bg-surface-700 text-[#1A3C34] dark:text-[#6B9E86] shadow-sm hover:bg-gray-50 dark:hover:bg-surface-600 transition-all"
            aria-label="Cerrar chat">
            <i class="pi pi-chevron-down text-xs"></i>
          </button>
        </div>

        <div #messagesContainer class="chat-messages-full">
          <!-- Mensajes reales del chat -->
          <div
            *ngFor="let message of messages; trackBy: trackByMessageId"
            class="message-wrapper"
            [class.bot-wrapper]="message.sender === 'bot'"
            [class.user-wrapper]="message.sender === 'user'">
            <!-- Mensaje del BOT -->
            <div
              *ngIf="message.sender === 'bot'"
              class="flex items-start space-x-2 mb-3 animate-[fadeIn_0.3s_ease-out]">
              <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
                <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
              </div>
              <div
                class="max-w-[80%] bg-white dark:bg-surface-700 text-gray-800 dark:text-surface-0 shadow-sm rounded-2xl rounded-tl-none p-3"
                role="article"
                aria-label="Mensaje de Maingoo AI">
                <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
              </div>
            </div>

            <!-- Mensaje del USUARIO -->
            <div
              *ngIf="message.sender === 'user'"
              class="flex items-start space-x-2 mb-3 justify-end animate-[fadeIn_0.3s_ease-out]">
              <div
                class="max-w-[80%] bg-[#6B9E86] dark:bg-[#1A3C34] text-white shadow-sm rounded-2xl rounded-tr-none p-3"
                role="article"
                aria-label="Tu mensaje">
                <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
              </div>
              <div
                class="w-6 h-6 bg-[#1A3C34] dark:bg-[#6B9E86] rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-user text-white text-xs" aria-hidden="true"></i>
              </div>
            </div>
          </div>

          <!-- Indicador de escritura -->
          <div
            class="flex items-start space-x-2 mb-3"
            *ngIf="isTyping"
            role="status"
            aria-live="polite"
            aria-label="Maingoo está escribiendo">
            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
              <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
            </div>
            <div class="bg-white dark:bg-surface-700 rounded-2xl rounded-tl-none p-3 shadow-sm">
              <div class="flex space-x-1">
                <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce" aria-hidden="true"></div>
                <div
                  class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.1s]"
                  aria-hidden="true"></div>
                <div
                  class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.2s]"
                  aria-hidden="true"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones rápidas contextuales -->
        <div class="flex-shrink-0 px-4 py-3 bg-[#F0F7F4] dark:bg-surface-800">
          <div class="grid grid-cols-2 gap-2">
            <button
              *ngFor="let action of currentContext.actions"
              (click)="handleQuickAction(action.action)"
              [attr.aria-label]="action.label"
              type="button"
              class="px-3 py-3 bg-[#6B9E86]/10 dark:bg-[#6B9E86]/20 text-[#1A3C34] dark:text-[#6B9E86] text-sm font-medium rounded-full hover:bg-[#6B9E86]/20 dark:hover:bg-[#6B9E86]/30 transition-all duration-200 flex items-center justify-center gap-2 text-center">
              <i [class]="action.icon + ' text-base'" aria-hidden="true"></i>
              <span class="truncate">{{ action.label }}</span>
            </button>
          </div>
        </div>

        <div class="input-container-full-sidebar">
          <button class="attach-button" type="button" aria-label="Adjuntar archivo">
            <i class="pi pi-paperclip" aria-hidden="true"></i>
          </button>
          <input
            #expandedInput
            type="text"
            placeholder="Escribe tu mensaje..."
            aria-label="Escribe tu mensaje"
            class="flex-1 px-4 py-3 bg-white dark:bg-surface-700 border-0 outline-0 text-sm text-gray-800 dark:text-surface-0 rounded-full shadow-sm focus:shadow-md transition-all"
            (keydown.enter)="sendMessage(expandedInput)" />
          <button
            (click)="sendMessage(expandedInput)"
            [disabled]="isTyping"
            type="button"
            aria-label="Enviar mensaje"
            class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
            <i
              class="pi pi-send text-white dark:text-[#1A3C34] text-sm"
              [class.animate-send]="isSending"
              aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
