<!-- Backdrop oscuro (solo visible en estado expanded) -->
<div class="bottom-sheet-backdrop" [class.active]="isDarkOverlay" (click)="onBackdropClick()"></div>

<!-- Contenedor del Bottom Sheet -->
<div
  #sheetContainer
  class="bottom-sheet-container"
  [class.compact]="bottomSheetService.currentState() === 'compact'"
  [class.medium]="bottomSheetService.currentState() === 'medium'"
  [class.expanded]="bottomSheetService.currentState() === 'expanded'"
  [style.height]="sheetHeight"
  (touchstart)="onTouchStart($event)"
  (touchmove)="onTouchMove($event)"
  (touchend)="onTouchEnd($event)">
  <!-- Handle / Drag Indicator -->
  <div class="sheet-handle" (click)="onHeaderClick()">
    <div class="handle-bar"></div>
  </div>

  <!-- Contenido del Sheet -->
  <div class="sheet-content">
    <!-- Estado Compacto: Solo menú e input -->
    <div class="compact-view" *ngIf="bottomSheetService.currentState() === 'compact'">
      <!-- Contenido scrolleable -->
      <div class="compact-content">
        <!-- Etiqueta MENU -->
        <div class="mb-2">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Menú</p>
          <div class="h-px bg-gray-300 dark:bg-gray-600 mt-1"></div>
        </div>

        <!-- Chips de navegación compactos en grid 3x2 -->
        <div class="mb-3">
          <div class="grid grid-cols-3 gap-2">
            <button
              *ngFor="let link of quickLinks"
              (click)="navigateTo(link.route, $event)"
              class="flex items-center justify-center gap-1.5 px-2 py-2 bg-white dark:bg-surface-700 text-[#1A3C34] dark:text-surface-0 rounded-full border-0 shadow-[0_2px_8px_rgba(26,60,52,0.05)] hover:text-[#6B9E86] hover:shadow-[0_4px_12px_rgba(26,60,52,0.1)] transition-all duration-200 cursor-pointer">
              <i [class]="link.icon + ' text-sm'"></i>
              <span class="text-[10px] font-medium whitespace-nowrap">{{ link.label }}</span>
            </button>
          </div>
        </div>

        <!-- Etiqueta CHAT -->
        <div class="mb-2">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Maingoo AI</p>
          <div class="h-px bg-gray-300 dark:bg-gray-600 mt-1"></div>
        </div>
      </div>

      <!-- Input fijo en la parte inferior -->
      <div class="input-container-compact" (click)="$event.stopPropagation()">
        <input
          #messageInput
          type="text"
          [placeholder]="currentContext.placeholder"
          class="flex-1 px-4 py-3 bg-white dark:bg-surface-700 border-0 outline-0 text-sm text-gray-800 dark:text-surface-0 rounded-full shadow-sm focus:shadow-md transition-all"
          (keydown.enter)="sendMessage(messageInput)" />
        <button
          (click)="sendMessage(messageInput)"
          [disabled]="isTyping"
          class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="pi pi-send text-white dark:text-[#1A3C34] text-sm"></i>
        </button>
      </div>
    </div>

    <!-- Estado Medio: Menú, acciones e input -->
    <div class="medium-view" *ngIf="bottomSheetService.currentState() === 'medium'">
      <!-- Contenido scrolleable -->
      <div class="medium-content">
        <!-- Etiqueta MENU -->
        <div class="mb-2">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Menú</p>
          <div class="h-px bg-gray-300 dark:bg-gray-600 mt-1"></div>
        </div>

        <!-- Chips de navegación en grid 3x2 -->
        <div class="mb-3">
          <div class="grid grid-cols-3 gap-2">
            <button
              *ngFor="let link of quickLinks"
              (click)="navigateTo(link.route, $event)"
              class="flex items-center justify-center gap-1.5 px-2 py-2 bg-white dark:bg-surface-700 text-[#1A3C34] dark:text-surface-0 rounded-full border-0 shadow-[0_2px_8px_rgba(26,60,52,0.05)] hover:text-[#6B9E86] hover:shadow-[0_4px_12px_rgba(26,60,52,0.1)] transition-all duration-200 cursor-pointer">
              <i [class]="link.icon + ' text-sm'"></i>
              <span class="text-[10px] font-medium whitespace-nowrap">{{ link.label }}</span>
            </button>
          </div>
        </div>

        <!-- Etiqueta CHAT -->
        <div class="mb-2">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Maingoo AI</p>
          <div class="h-px bg-gray-300 dark:bg-gray-600 mt-1"></div>
        </div>

        <!-- Acciones rápidas contextuales -->
        <div class="mb-3">
          <div class="grid grid-cols-2 gap-2">
            <button
              *ngFor="let action of currentContext.actions"
              (click)="handleQuickAction(action.action)"
              class="px-2 py-2 bg-[#6B9E86]/10 dark:bg-[#6B9E86]/20 text-[#1A3C34] dark:text-[#6B9E86] text-[10px] font-medium rounded-full hover:bg-[#6B9E86]/20 dark:hover:bg-[#6B9E86]/30 transition-all duration-200 flex items-center justify-center gap-1.5 text-center">
              <i [class]="action.icon + ' text-xs'"></i>
              <span class="truncate">{{ action.label }}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Input fijo en la parte inferior -->
      <div class="input-container-medium" (click)="$event.stopPropagation()">
        <input
          #mediumInput
          type="text"
          [placeholder]="currentContext.placeholder"
          class="flex-1 px-4 py-3 bg-white dark:bg-surface-700 border-0 outline-0 text-sm text-gray-800 dark:text-surface-0 rounded-full shadow-sm focus:shadow-md transition-all"
          (keydown.enter)="sendMessage(mediumInput)" />
        <button
          (click)="sendMessage(mediumInput)"
          [disabled]="isTyping"
          class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="pi pi-send text-white dark:text-[#1A3C34] text-sm"></i>
        </button>
      </div>
    </div>

    <!-- Estado Expandido: Conversación completa -->
    <div class="expanded-view" *ngIf="bottomSheetService.currentState() === 'expanded'">
      <!-- Chips de navegación expandidos en grid 3x2 en la parte superior -->
      <div class="px-4 pt-2 pb-3 bg-[#F0F7F4] dark:bg-surface-800 border-b border-gray-200 dark:border-surface-700">
        <!-- Etiqueta MENU -->
        <div class="mb-2">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Menú</p>
          <!-- <div class="h-px bg-gray-300 dark:bg-gray-600 mt-1"></div> -->
        </div>

        <!-- Chips compactos en grid 3x2 -->
        <div class="mb-3">
          <div class="grid grid-cols-3 gap-2">
            <button
              *ngFor="let link of quickLinks"
              (click)="navigateTo(link.route, $event)"
              class="flex items-center justify-center gap-1.5 px-2 py-2 bg-white dark:bg-surface-700 text-[#1A3C34] dark:text-surface-0 rounded-full border-0 shadow-[0_2px_8px_rgba(26,60,52,0.05)] hover:text-[#6B9E86] hover:shadow-[0_4px_12px_rgba(26,60,52,0.1)] transition-all duration-200 cursor-pointer">
              <i [class]="link.icon + ' text-sm'"></i>
              <span class="text-[10px] font-medium whitespace-nowrap">{{ link.label }}</span>
            </button>
          </div>
        </div>

        <!-- Etiqueta CHAT -->
        <div class="mb-0">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Maingoo AI</p>
          <!-- <div class="h-px bg-gray-300 dark:bg-gray-600 mt-1"></div> -->
        </div>
      </div>

      <div #messagesContainer class="chat-messages-full">
        <!-- Mensajes reales del chat -->
        <div
          *ngFor="let message of messages; trackBy: trackByMessageId"
          class="message-wrapper"
          [class.bot-wrapper]="message.sender === 'bot'"
          [class.user-wrapper]="message.sender === 'user'">
          <!-- Mensaje del BOT -->
          <div *ngIf="message.sender === 'bot'" class="flex items-start space-x-2 mb-3 animate-[fadeIn_0.3s_ease-out]">
            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
              <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
            </div>
            <div
              class="max-w-[80%] bg-white dark:bg-surface-700 text-gray-800 dark:text-surface-0 shadow-sm rounded-2xl rounded-tl-none p-3">
              <p class="m-0 text-sm leading-relaxed" [innerHTML]="message.text"></p>
            </div>
          </div>

          <!-- Mensaje del USUARIO -->
          <div
            *ngIf="message.sender === 'user'"
            class="flex items-start space-x-2 mb-3 justify-end animate-[fadeIn_0.3s_ease-out]">
            <div
              class="max-w-[80%] bg-[#6B9E86] dark:bg-[#1A3C34] text-white shadow-sm rounded-2xl rounded-tr-none p-3">
              <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
            </div>
            <div
              class="w-6 h-6 bg-[#1A3C34] dark:bg-[#6B9E86] rounded-full flex items-center justify-center flex-shrink-0">
              <i class="pi pi-user text-white text-xs"></i>
            </div>
          </div>
        </div>

        <!-- Indicador de escritura -->
        <div class="flex items-start space-x-2 mb-3" *ngIf="isTyping">
          <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
            <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
          </div>
          <div class="bg-white dark:bg-surface-700 rounded-2xl rounded-tl-none p-3 shadow-sm">
            <div class="flex space-x-1">
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.1s]"></div>
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.2s]"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones rápidas contextuales -->
      <div class="flex-shrink-0 px-4 py-3 bg-[#F0F7F4] dark:bg-surface-800">
        <div class="grid grid-cols-2 gap-2">
          <button
            *ngFor="let action of currentContext.actions"
            (click)="handleQuickAction(action.action)"
            class="px-3 py-2.5 bg-[#6B9E86]/10 dark:bg-[#6B9E86]/20 text-[#1A3C34] dark:text-[#6B9E86] text-[11px] font-medium rounded-full hover:bg-[#6B9E86]/20 dark:hover:bg-[#6B9E86]/30 transition-all duration-200 flex items-center justify-center gap-1.5 text-center">
            <i [class]="action.icon + ' text-xs'"></i>
            <span class="truncate">{{ action.label }}</span>
          </button>
        </div>
      </div>

      <div class="input-container-full-sidebar">
        <button class="attach-button">
          <i class="pi pi-paperclip"></i>
        </button>
        <input
          #expandedInput
          type="text"
          placeholder="Escribe tu mensaje..."
          class="flex-1 px-4 py-3 bg-white dark:bg-surface-700 border-0 outline-0 text-sm text-gray-800 dark:text-surface-0 rounded-full shadow-sm focus:shadow-md transition-all"
          (keydown.enter)="sendMessage(expandedInput)" />
        <button
          (click)="sendMessage(expandedInput)"
          [disabled]="isTyping"
          class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="pi pi-send text-white dark:text-[#1A3C34] text-sm"></i>
        </button>
      </div>
    </div>
  </div>
</div>
