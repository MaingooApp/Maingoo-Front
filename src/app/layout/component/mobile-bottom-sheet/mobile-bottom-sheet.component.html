<!-- Backdrop oscuro (solo visible en estado expanded) -->
<div 
  class="bottom-sheet-backdrop"
  [class.active]="isDarkOverlay"
  (click)="onBackdropClick()">
</div>

<!-- Contenedor del Bottom Sheet -->
<div 
  #sheetContainer
  class="bottom-sheet-container"
  [class.compact]="bottomSheetService.currentState() === 'compact'"
  [class.medium]="bottomSheetService.currentState() === 'medium'"
  [class.expanded]="bottomSheetService.currentState() === 'expanded'"
  [style.height]="sheetHeight"
  (touchstart)="onTouchStart($event)"
  (touchmove)="onTouchMove($event)"
  (touchend)="onTouchEnd($event)">
  
  <!-- Handle / Drag Indicator -->
  <div class="sheet-handle" (click)="onHeaderClick()">
    <div class="handle-bar"></div>
  </div>

  <!-- Contenido del Sheet -->
  <div class="sheet-content">
    
    <!-- Estado Compacto: Solo input y chips -->
    <div class="compact-view" *ngIf="bottomSheetService.currentState() === 'compact'">
      <div class="quick-chips">
        <button class="chip">ğŸ“Š Dashboard</button>
        <button class="chip">ğŸ“„ Facturas</button>
        <button class="chip">ğŸ¢ Empresas</button>
        <button class="chip">âš™ï¸ Config</button>
      </div>
      
      <div class="input-container">
        <input 
          #messageInput
          type="text" 
          placeholder="PregÃºntame algo..."
          class="chat-input"
          (keydown.enter)="sendMessage(messageInput)">
        <button class="send-button" (click)="sendMessage(messageInput)">
          <i class="pi pi-send"></i>
        </button>
      </div>
    </div>

    <!-- Estado Medio: Respuestas breves + menÃº -->
    <div class="medium-view" *ngIf="bottomSheetService.currentState() === 'medium'">
      <div class="chat-header">
        <h3>Maingoo AI</h3>
        <span class="status-indicator">ğŸŸ¢ En lÃ­nea</span>
      </div>

      <div #messagesContainer class="chat-messages">
        <!-- Mensajes reales del chat -->
        <div 
          *ngFor="let message of messages; trackBy: trackByMessageId"
          class="message-wrapper"
          [class.bot-wrapper]="message.sender === 'bot'"
          [class.user-wrapper]="message.sender === 'user'">
          
          <!-- Mensaje del BOT -->
          <div *ngIf="message.sender === 'bot'" class="flex items-start space-x-2 mb-3 animate-[fadeIn_0.3s_ease-out]">
            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
              <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
            </div>
            <div class="max-w-[80%] bg-white dark:bg-surface-700 text-gray-800 dark:text-surface-0 shadow-sm rounded-2xl rounded-tl-none p-3">
              <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
            </div>
          </div>

          <!-- Mensaje del USUARIO -->
          <div *ngIf="message.sender === 'user'" class="flex items-start space-x-2 mb-3 justify-end animate-[fadeIn_0.3s_ease-out]">
            <div class="max-w-[80%] bg-[#6B9E86] dark:bg-[#1A3C34] text-white shadow-sm rounded-2xl rounded-tr-none p-3">
              <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
            </div>
            <div class="w-6 h-6 bg-[#1A3C34] dark:bg-[#6B9E86] rounded-full flex items-center justify-center flex-shrink-0">
              <i class="pi pi-user text-white text-xs"></i>
            </div>
          </div>
        </div>

        <!-- Indicador de escritura -->
        <div class="flex items-start space-x-2 mb-3" *ngIf="isTyping">
          <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
            <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
          </div>
          <div class="bg-white dark:bg-surface-700 rounded-2xl rounded-tl-none p-3 shadow-sm">
            <div class="flex space-x-1">
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.1s]"></div>
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.2s]"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="input-container-sidebar">
        <input 
          #mediumInput
          type="text" 
          placeholder="Escribe tu mensaje..."
          class="flex-1 px-4 py-3 bg-white dark:bg-surface-700 border-0 outline-0 text-sm text-gray-800 dark:text-surface-0 rounded-full shadow-sm focus:shadow-md transition-all"
          (keydown.enter)="sendMessage(mediumInput)">
        <button 
          (click)="sendMessage(mediumInput)"
          [disabled]="isTyping"
          class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="pi pi-send text-white dark:text-[#1A3C34] text-sm"></i>
        </button>
      </div>
    </div>

    <!-- Estado Expandido: ConversaciÃ³n completa -->
    <div class="expanded-view" *ngIf="bottomSheetService.currentState() === 'expanded'">
      <div class="chat-header-full">
        <button class="back-button" (click)="bottomSheetService.setState('medium')">
          <i class="pi pi-arrow-left"></i>
        </button>
        <div class="header-info">
          <h3>Chat con Maingoo AI</h3>
          <span class="subtitle">Asistente inteligente</span>
        </div>
        <button class="menu-button">
          <i class="pi pi-ellipsis-v"></i>
        </button>
      </div>

      <div #messagesContainer class="chat-messages-full">
        <!-- Mensajes reales del chat -->
        <div 
          *ngFor="let message of messages; trackBy: trackByMessageId"
          class="message-wrapper"
          [class.bot-wrapper]="message.sender === 'bot'"
          [class.user-wrapper]="message.sender === 'user'">
          
          <!-- Mensaje del BOT -->
          <div *ngIf="message.sender === 'bot'" class="flex items-start space-x-2 mb-3 animate-[fadeIn_0.3s_ease-out]">
            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
              <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
            </div>
            <div class="max-w-[80%] bg-white dark:bg-surface-700 text-gray-800 dark:text-surface-0 shadow-sm rounded-2xl rounded-tl-none p-3">
              <p class="m-0 text-sm leading-relaxed" [innerHTML]="message.text"></p>
            </div>
          </div>

          <!-- Mensaje del USUARIO -->
          <div *ngIf="message.sender === 'user'" class="flex items-start space-x-2 mb-3 justify-end animate-[fadeIn_0.3s_ease-out]">
            <div class="max-w-[80%] bg-[#6B9E86] dark:bg-[#1A3C34] text-white shadow-sm rounded-2xl rounded-tr-none p-3">
              <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
            </div>
            <div class="w-6 h-6 bg-[#1A3C34] dark:bg-[#6B9E86] rounded-full flex items-center justify-center flex-shrink-0">
              <i class="pi pi-user text-white text-xs"></i>
            </div>
          </div>
        </div>

        <!-- Indicador de escritura -->
        <div class="flex items-start space-x-2 mb-3" *ngIf="isTyping">
          <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
            <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
          </div>
          <div class="bg-white dark:bg-surface-700 rounded-2xl rounded-tl-none p-3 shadow-sm">
            <div class="flex space-x-1">
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.1s]"></div>
              <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.2s]"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="input-container-full-sidebar">
        <button class="attach-button">
          <i class="pi pi-paperclip"></i>
        </button>
        <input 
          #expandedInput
          type="text" 
          placeholder="Escribe tu mensaje..."
          class="flex-1 px-4 py-3 bg-white dark:bg-surface-700 border-0 outline-0 text-sm text-gray-800 dark:text-surface-0 rounded-full shadow-sm focus:shadow-md transition-all"
          (keydown.enter)="sendMessage(expandedInput)">
        <button 
          (click)="sendMessage(expandedInput)"
          [disabled]="isTyping"
          class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="pi pi-send text-white dark:text-[#1A3C34] text-sm"></i>
        </button>
      </div>
    </div>

  </div>
</div>
