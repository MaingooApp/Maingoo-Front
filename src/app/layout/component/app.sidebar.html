<!-- Chat lateral permanente -->
<div class="layout-sidebar !flex !flex-col !overflow-hidden !p-0" [ngClass]="sidebarClass">
  <!-- Píldoras de navegación rápida -->
  <div class="flex-shrink-0 px-4 pt-4 pb-3 bg-[#F0F7F4] dark:bg-surface-900">
    <!-- Etiqueta MENU -->
    <div class="mb-3">
      <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Menú</p>
      <div class="h-px bg-gray-300 dark:bg-gray-600 mt-2"></div>
    </div>
    @if (layoutService.isNotificationPanelActiveOrAnimating()) {
    <!-- Chips compactos cuando el panel de notificaciones está activo -->
    <div class="grid grid-cols-3 gap-2">
      @for (link of quickLinks; track link.route) {
      <a
        [routerLink]="link.route"
        routerLinkActive="!text-[#6B9E86] !shadow-[0_6px_16px_rgba(26,60,52,0.1)]"
        class="flex items-center justify-center gap-1 px-2 py-2 bg-white dark:bg-surface-700 text-[#1A3C34] dark:text-surface-0 rounded-full border-0 shadow-[0_4px_12px_rgba(26,60,52,0.05)] hover:text-[#6B9E86] hover:shadow-[0_6px_16px_rgba(26,60,52,0.1)] transition-all duration-200 cursor-pointer">
        <i [class]="link.icon + ' text-xs flex-shrink-0'"></i>
        <span class="text-[10px] font-medium whitespace-nowrap">{{ link.label }}</span>
      </a>
      }
    </div>
    } @else {
    <!-- Grid normal cuando solo está el chat -->
    <div class="grid grid-cols-3 gap-3">
      @for (link of quickLinks; track link.route) {
      <a
        [routerLink]="link.route"
        routerLinkActive="!text-[#6B9E86] !shadow-[0_6px_16px_rgba(26,60,52,0.1)]"
        class="flex flex-col items-center justify-center p-4 bg-white dark:bg-surface-700 text-[#1A3C34] dark:text-surface-0 rounded-2xl border-0 shadow-[0_4px_12px_rgba(26,60,52,0.05)] hover:text-[#6B9E86] hover:shadow-[0_6px_16px_rgba(26,60,52,0.1)] transition-all duration-200 cursor-pointer">
        <i [class]="link.icon + ' text-xl mb-2'"></i>
        <span class="text-[11px] font-medium text-center leading-tight">{{ link.label }}</span>
      </a>
      }
    </div>
    }

    <!-- Etiqueta CHAT -->
    <div class="mt-3">
      <!-- <div class="h-px bg-gray-300 dark:bg-gray-600 mb-2"></div> -->
      <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-0">Maingo AI</p>
      <div class="h-px bg-gray-300 dark:bg-gray-600 mt-2"></div>
    </div>
  </div>

  <!-- Área de mensajes expandida -->
  <div id="chat-messages-expanded" class="flex-1 min-h-0 p-4 overflow-y-auto bg-[#F0F7F4] dark:bg-surface-800">
    <!-- Mensajes dinámicos -->
    @for (message of messages; track message.id; let idx = $index) { @if (message.sender === 'bot') {
    <!-- Mensaje del BOT -->
    <div class="flex items-start space-x-2 mb-3 animate-[fadeIn_0.3s_ease-out]">
      <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
        <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
      </div>
      <div
        class="max-w-[80%] bg-white dark:bg-surface-700 text-gray-800 dark:text-surface-0 shadow-sm rounded-2xl rounded-tl-none p-3">
        <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
      </div>
    </div>
    } @else {
    <!-- Mensaje del USUARIO -->
    <div class="flex items-start space-x-2 mb-3 justify-end animate-[fadeIn_0.3s_ease-out]">
      <div class="max-w-[80%] bg-[#6B9E86] dark:bg-[#1A3C34] text-white shadow-sm rounded-2xl rounded-tr-none p-3">
        <p class="m-0 text-sm leading-relaxed">{{ message.text }}</p>
      </div>
      <div class="w-6 h-6 bg-[#1A3C34] dark:bg-[#6B9E86] rounded-full flex items-center justify-center flex-shrink-0">
        <i class="pi pi-user text-white text-xs"></i>
      </div>
    </div>
    } }

    <!-- Indicador de escritura -->
    @if (isTyping) {
    <div class="flex items-start space-x-2 mb-3">
      <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0">
        <img src="assets/images/maingoo_logo.svg" alt="Maingoo Logo" class="w-6 h-6 object-contain" />
      </div>
      <div class="bg-white dark:bg-surface-700 rounded-2xl rounded-tl-none p-3 shadow-sm">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.1s]"></div>
          <div class="w-2 h-2 bg-[#6B9E86] rounded-full animate-bounce [animation-delay:0.2s]"></div>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Acciones rápidas -->
  <div class="flex-shrink-0 px-4 py-3 bg-[#F0F7F4] dark:bg-surface-800">
    <h4 class="text-sm font-medium text-[#1A3C34] dark:text-[#6B9E86] mb-3 italic">Acciones rápidas</h4>
    <div class="flex flex-wrap gap-2">
      <button
        (click)="handleQuickAction('Subir factura')"
        class="px-4 py-2 bg-[#6B9E86]/10 dark:bg-[#6B9E86]/20 text-[#1A3C34] dark:text-[#6B9E86] text-[13px] font-medium rounded-full hover:bg-[#6B9E86]/20 dark:hover:bg-[#6B9E86]/30 transition-all duration-200 flex items-center gap-2">
        <i class="pi pi-upload text-xs"></i>
        <span>Subir factura</span>
      </button>
      <button
        (click)="handleQuickAction('Informe de compras')"
        class="px-4 py-2 bg-[#6B9E86]/10 dark:bg-[#6B9E86]/20 text-[#1A3C34] dark:text-[#6B9E86] text-[13px] font-medium rounded-full hover:bg-[#6B9E86]/20 dark:hover:bg-[#6B9E86]/30 transition-all duration-200 flex items-center gap-2">
        <i class="pi pi-chart-bar text-xs"></i>
        <span>Informe de compras</span>
      </button>
    </div>
  </div>

  <!-- Input de mensaje expandido -->
  <div class="flex-shrink-0 p-4 bg-[#F0F7F4] dark:bg-surface-800">
    <div class="flex items-center gap-3">
      <!-- Icono de micrófono -->
      <button
        (click)="handleVoiceInput()"
        disabled
        class="flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-full transition-all opacity-50 cursor-not-allowed"
        aria-label="Grabar nota de voz (próximamente)">
        <i class="pi pi-microphone text-gray-400 dark:text-gray-500 text-base"></i>
      </button>

      <!-- Botón de adjuntar con menú desplegable -->
      <div class="relative" id="attachment-menu-container">
        <button
          (click)="showAttachmentMenu = !showAttachmentMenu"
          [disabled]="isTyping"
          class="flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/50 dark:hover:bg-surface-700/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Adjuntar archivo">
          <i class="pi pi-paperclip text-[#6B9E86] dark:text-[#8BC4A8] text-base"></i>
        </button>

        <!-- Menú desplegable -->
        @if (showAttachmentMenu) {
        <div
          class="absolute bottom-full left-0 mb-2 bg-white dark:bg-surface-900 rounded-xl shadow-lg border border-gray-200 dark:border-surface-700 py-2 min-w-[160px] z-50">
          <button
            (click)="handleCameraCapture(); showAttachmentMenu = false"
            class="w-full px-4 py-2 text-left text-sm text-[#1A3C34] dark:text-surface-0 hover:bg-[#F0F7F4] dark:hover:bg-surface-700 flex items-center gap-3 transition-colors">
            <i class="pi pi-camera text-[#6B9E86] dark:text-[#8BC4A8]"></i>
            <span>Tomar foto</span>
          </button>
          <button
            (click)="handleFileUpload(); showAttachmentMenu = false"
            class="w-full px-4 py-2 text-left text-sm text-[#1A3C34] dark:text-surface-0 hover:bg-[#F0F7F4] dark:hover:bg-surface-700 flex items-center gap-3 transition-colors">
            <i class="pi pi-file text-[#6B9E86] dark:text-[#8BC4A8]"></i>
            <span>Subir archivo</span>
          </button>
        </div>
        }
      </div>

      <!-- Input de archivo oculto para cámara -->
      <input
        #cameraInput
        type="file"
        accept="image/*"
        capture="environment"
        (change)="onCameraCapture($event)"
        class="hidden" />

      <!-- Input de archivo oculto para subir archivos -->
      <input #fileInput type="file" accept="image/*,application/pdf" (change)="onFileSelected($event)" class="hidden" />

      <textarea
        #messageInput
        [(ngModel)]="messageText"
        (keydown)="handleKeyDown($event)"
        (input)="autoResize()"
        placeholder="Escribe un mensaje..."
        [maxlength]="maxMessageLength"
        rows="1"
        class="flex-1 px-3 py-2 border-0 outline-none text-sm bg-white/50 dark:bg-surface-700/50 rounded-2xl placeholder:text-gray-500 dark:placeholder:text-gray-400 text-[#1A3C34] dark:text-surface-0 resize-none overflow-hidden max-h-32"></textarea>

      <!-- Botón de enviar circular -->
      <button
        (click)="sendMessage()"
        [disabled]="!messageText.trim() || isTyping"
        class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1A3C34] dark:bg-[#6B9E86] flex items-center justify-center hover:bg-[#6B9E86] dark:hover:bg-[#8BC4A8] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        aria-label="Enviar mensaje">
        <i class="pi pi-send text-white dark:text-[#1A3C34] text-sm"></i>
      </button>
    </div>
    @if (messageText.length > 0) {
    <div
      class="text-xs text-right mt-2 px-2 text-gray-600 dark:text-gray-400"
      [class.!text-red-500]="messageText.length >= maxMessageLength">
      {{ messageText.length }} / {{ maxMessageLength }}
    </div>
    }
  </div>
  
  <!-- Footer dentro del sidebar -->
  <div class="flex-shrink-0 py-3 text-center text-xs text-gray-400 dark:text-gray-500 bg-[#F0F7F4] dark:bg-surface-800">
    Maingoo © {{ currentYear }}
  </div>
</div>


<style>
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
